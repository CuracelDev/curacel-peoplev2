image: atlassian/default-image:3

definitions:
  services:
    docker:
      memory: 3072

pipelines:
  branches:
    main:
      - step:
          name: Deploy to EC2
          deployment: production
          script:
            # Deploy code to server using rsync pipe
            - pipe: atlassian/rsync-deploy:0.12.0
              variables:
                USER: $SSH_USER
                SERVER: $SSH_HOST
                REMOTE_PATH: /home/ubuntu/peopleos/
                LOCAL_PATH: $BITBUCKET_CLONE_DIR/
                EXTRA_ARGS: '-avz --exclude=.git --exclude=node_modules --exclude=.next --exclude=*.log --exclude=.env --exclude=dist --exclude=.local --exclude=prisma/*.db --exclude=coverage'
                DELETE_FLAG: 'false'
                SUDO: 'false'
            
            # Create .env file on server
            - echo "Creating .env file on server..."
            - pipe: atlassian/ssh-run:0.4.1
              variables:
                SSH_USER: $SSH_USER
                SERVER: $SSH_HOST
                MODE: 'command'
                NEXTAUTH_SECRET_VAL: $NEXTAUTH_SECRET
                NEXTAUTH_URL_VAL: $NEXTAUTH_URL
                GOOGLE_CLIENT_ID_VAL: $GOOGLE_CLIENT_ID
                GOOGLE_CLIENT_SECRET_VAL: $GOOGLE_CLIENT_SECRET
                EMAIL_SERVER_HOST_VAL: $EMAIL_SERVER_HOST
                EMAIL_SERVER_PORT_VAL: $EMAIL_SERVER_PORT
                EMAIL_SERVER_USER_VAL: $EMAIL_SERVER_USER
                EMAIL_SERVER_PASSWORD_VAL: $EMAIL_SERVER_PASSWORD
                EMAIL_FROM_VAL: $EMAIL_FROM
                POSTMARK_SERVER_TOKEN_VAL: $POSTMARK_SERVER_TOKEN
                POSTMARK_FROM_VAL: $POSTMARK_FROM
                DOCUSIGN_CLIENT_ID_VAL: $DOCUSIGN_CLIENT_ID
                DOCUSIGN_CLIENT_SECRET_VAL: $DOCUSIGN_CLIENT_SECRET
                DOCUSIGN_REDIRECT_URI_VAL: $DOCUSIGN_REDIRECT_URI
                UPLOADTHING_SECRET_VAL: $UPLOADTHING_SECRET
                UPLOADTHING_APP_ID_VAL: $UPLOADTHING_APP_ID
                ENCRYPTION_KEY_VAL: $ENCRYPTION_KEY
                DEV_PASSWORDLESS_LOGIN_VAL: $DEV_PASSWORDLESS_LOGIN
                DEV_AUTO_CREATE_SUPER_ADMIN_VAL: $DEV_AUTO_CREATE_SUPER_ADMIN
                COMMAND: |
                  cd /home/ubuntu/peopleos
                  
                  # Create .env file with actual values from pipe variables
                  echo "NODE_ENV=production" > .env
                  echo "PORT=3800" >> .env
                  echo "NEXTAUTH_SECRET=$NEXTAUTH_SECRET_VAL" >> .env
                  echo "NEXTAUTH_URL=$NEXTAUTH_URL_VAL" >> .env
                  echo "GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID_VAL" >> .env
                  echo "GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET_VAL" >> .env
                  echo "EMAIL_SERVER_HOST=$EMAIL_SERVER_HOST_VAL" >> .env
                  echo "EMAIL_SERVER_PORT=$EMAIL_SERVER_PORT_VAL" >> .env
                  echo "EMAIL_SERVER_USER=$EMAIL_SERVER_USER_VAL" >> .env
                  echo "EMAIL_SERVER_PASSWORD=$EMAIL_SERVER_PASSWORD_VAL" >> .env
                  echo "EMAIL_FROM=$EMAIL_FROM_VAL" >> .env
                  echo "POSTMARK_SERVER_TOKEN=$POSTMARK_SERVER_TOKEN_VAL" >> .env
                  echo "POSTMARK_FROM=$POSTMARK_FROM_VAL" >> .env
                  echo "DOCUSIGN_CLIENT_ID=$DOCUSIGN_CLIENT_ID_VAL" >> .env
                  echo "DOCUSIGN_CLIENT_SECRET=$DOCUSIGN_CLIENT_SECRET_VAL" >> .env
                  echo "DOCUSIGN_REDIRECT_URI=$DOCUSIGN_REDIRECT_URI_VAL" >> .env
                  echo "UPLOADTHING_SECRET=$UPLOADTHING_SECRET_VAL" >> .env
                  echo "UPLOADTHING_APP_ID=$UPLOADTHING_APP_ID_VAL" >> .env
                  echo "ENCRYPTION_KEY=$ENCRYPTION_KEY_VAL" >> .env
                  echo "DEV_PASSWORDLESS_LOGIN=$DEV_PASSWORDLESS_LOGIN_VAL" >> .env
                  echo "DEV_AUTO_CREATE_SUPER_ADMIN=$DEV_AUTO_CREATE_SUPER_ADMIN_VAL" >> .env
                  
                  echo "Checking environment variables..." && cat .env | head -5

            # Deploy application (Integrated Step)
            - pipe: atlassian/ssh-run:0.4.1
              variables:
                SSH_USER: $SSH_USER
                SERVER: $SSH_HOST
                MODE: 'command'
                COMMAND: |
                  cd /home/ubuntu/peopleos

                  # Check/Install Docker
                  if ! command -v docker &> /dev/null; then
                    echo "Installing Docker..."
                    curl -fsSL https://get.docker.com -o get-docker.sh && sudo sh get-docker.sh
                    sudo usermod -aG docker $USER
                    sudo systemctl enable docker && sudo systemctl start docker
                  fi
                  docker --version && docker compose version

                  # Stop existing containers
                  echo "Stopping containers..."
                  timeout 60 docker compose -f docker-compose.deploy.yml down --remove-orphans 2>/dev/null || echo "Cleanup finished"

                  # Build with caching enabled
                  echo "Building images..."
                  docker compose -f docker-compose.deploy.yml build

                  # Start DB
                  echo "Starting database..."
                  docker compose -f docker-compose.deploy.yml up -d postgres redis

                  # Wait for DB
                  echo "Waiting for database..."
                  sleep 10
                  docker exec curacel-people-db pg_isready -U curacel -d curacel_people

                  # Migrate
                  echo "Running migrations..."
                  docker compose -f docker-compose.deploy.yml run --rm app sh -c "npx -y prisma@5.10.2 db push && npx -y tsx prisma/seed.ts"

                  # Start App
                  echo "Starting app..."
                  docker compose -f docker-compose.deploy.yml up -d app

                  # Health Check
                  sleep 15
                  echo "=== Container Status ==="
                  docker compose -f docker-compose.deploy.yml ps
                  echo "=== App Logs ==="
                  docker logs curacel-people-app --tail 30
                  echo "=== Health Check ==="
                  curl -s -o /dev/null -w "%{http_code}" http://localhost:3500 || echo "App might be starting..."
                  echo ""
                  echo "✅ Deployment complete!"

  default:
    - step:
        name: Test Build
        services:
          - docker
        caches:
          - node
        script:
          - echo "Testing Next.js build..."
          - npm ci --legacy-peer-deps
          - npx -y prisma@5.10.2 generate
          - npm run build
          - echo "✓ Build successful!"

  pull-requests:
    '**':
      - step:
          name: Test Build
          services:
            - docker
          caches:
            - node
          script:
            - echo "Testing Next.js build..."
            - npm ci --legacy-peer-deps
            - npx -y prisma@5.10.2 generate
            - npm run build
            - echo "✓ Build successful!"