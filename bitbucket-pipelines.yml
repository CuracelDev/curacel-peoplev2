image: atlassian/default-image:3

definitions:
  services:
    docker:
      memory: 3072

pipelines:
  branches:
    main:
      - step:
          name: Deploy to EC2
          deployment: production
          script:
            # Deploy code to server using rsync pipe
            - pipe: atlassian/rsync-deploy:0.12.0
              variables:
                USER: $SSH_USER
                SERVER: $SSH_HOST
                REMOTE_PATH: /home/$SSH_USER/curacel-people/
                LOCAL_PATH: $BITBUCKET_CLONE_DIR/
                EXTRA_ARGS: '-avz --exclude=.git --exclude=node_modules --exclude=.next --exclude=*.log --exclude=.env --exclude=dist --exclude=.local --exclude=prisma/*.db --exclude=coverage'
                DELETE_FLAG: 'false'
                SUDO: 'false'
            
            # Create .env file on server
            - echo "Creating .env file on server..."
            - pipe: atlassian/ssh-run:0.4.1
              variables:
                SSH_USER: $SSH_USER
                SERVER: $SSH_HOST
                MODE: 'command'
                COMMAND: |
                  cd /home/$SSH_USER/curacel-people
                  
                  # Create .env file
                  cat > .env << ENVEOF
                  NODE_ENV=production
                  PORT=3500
                  NEXTAUTH_SECRET=$NEXTAUTH_SECRET
                  NEXTAUTH_URL=$NEXTAUTH_URL
                  GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID
                  GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET
                  EMAIL_SERVER_HOST=$EMAIL_SERVER_HOST
                  EMAIL_SERVER_PORT=$EMAIL_SERVER_PORT
                  EMAIL_SERVER_USER=$EMAIL_SERVER_USER
                  EMAIL_SERVER_PASSWORD=$EMAIL_SERVER_PASSWORD
                  EMAIL_FROM=$EMAIL_FROM
                  POSTMARK_SERVER_TOKEN=$POSTMARK_SERVER_TOKEN
                  POSTMARK_FROM=$POSTMARK_FROM
                  DOCUSIGN_CLIENT_ID=$DOCUSIGN_CLIENT_ID
                  DOCUSIGN_CLIENT_SECRET=$DOCUSIGN_CLIENT_SECRET
                  DOCUSIGN_REDIRECT_URI=$DOCUSIGN_REDIRECT_URI
                  UPLOADTHING_SECRET=$UPLOADTHING_SECRET
                  UPLOADTHING_APP_ID=$UPLOADTHING_APP_ID
                  ENCRYPTION_KEY=$ENCRYPTION_KEY
                  DEV_PASSWORDLESS_LOGIN=$DEV_PASSWORDLESS_LOGIN
                  DEV_AUTO_CREATE_SUPER_ADMIN=$DEV_AUTO_CREATE_SUPER_ADMIN
                  ENVEOF
                  
                  echo "Checking environment variables..." && cat .env | head -5

            # Deploy application (Integrated Step)
            - pipe: atlassian/ssh-run:0.4.1
              variables:
                SSH_USER: $SSH_USER
                SERVER: $SSH_HOST
                MODE: 'command'
                COMMAND: |
                  cd /home/$SSH_USER/curacel-people

                  # Check/Install Docker
                  if ! command -v docker &> /dev/null; then
                    echo "Installing Docker..."
                    curl -fsSL https://get.docker.com -o get-docker.sh && sudo sh get-docker.sh
                    sudo usermod -aG docker $USER
                    sudo systemctl enable docker && sudo systemctl start docker
                  fi
                  docker --version && docker compose version

                  # Stop existing containers
                  echo "Stopping containers..."
                  timeout 60 docker compose -f docker-compose.deploy.yml down --remove-orphans 2>/dev/null || echo "Cleanup finished"

                  # Build with caching enabled
                  echo "Building images..."
                  docker compose -f docker-compose.deploy.yml build

                  # Start DB
                  echo "Starting database..."
                  docker compose -f docker-compose.deploy.yml up -d postgres redis

                  # Wait for DB
                  echo "Waiting for database..."
                  sleep 10
                  docker exec curacel-people-db pg_isready -U curacel -d curacel_people

                  # Migrate
                  echo "Running migrations..."
                  docker compose -f docker-compose.deploy.yml run --rm app sh -c "npx -y prisma@5.10.2 db push && npx -y tsx prisma/seed.ts"

                  # Start App
                  echo "Starting app..."
                  docker compose -f docker-compose.deploy.yml up -d app

                  # Health Check
                  sleep 15
                  echo "=== Container Status ==="
                  docker compose -f docker-compose.deploy.yml ps
                  echo "=== App Logs ==="
                  docker logs curacel-people-app --tail 30
                  echo "=== Health Check ==="
                  curl -s -o /dev/null -w "%{http_code}" http://localhost:3500 || echo "App might be starting..."
                  echo ""
                  echo "✅ Deployment complete!"

  default:
    - step:
        name: Test Build
        services:
          - docker
        caches:
          - node
        script:
          - echo "Testing Next.js build..."
          - npm ci --legacy-peer-deps
          - npx -y prisma@5.10.2 generate
          - npm run build
          - echo "✓ Build successful!"

  pull-requests:
    '**':
      - step:
          name: Test Build
          services:
            - docker
          caches:
            - node
          script:
            - echo "Testing Next.js build..."
            - npm ci --legacy-peer-deps
            - npx -y prisma@5.10.2 generate
            - npm run build
            - echo "✓ Build successful!"