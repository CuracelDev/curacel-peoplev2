image: atlassian/default-image:3

definitions:
  services:
    docker:
      memory: 7168

pipelines:
  branches:
    main:
      - step:
          name: Build and Deploy to EC2
          size: 2x
          services:
            - docker
          script:
          # 1. Setup SSH
          - mkdir -p ~/.ssh
          - (umask 077 && echo "$SSH_PRIVATE_KEY" > ~/.ssh/pipelines_id)
          - chmod 600 ~/.ssh/pipelines_id

          # 2. Build Image on Pipeline Runner (Isolates heavy load from Prod)
          - echo "Building production image on runner..."
          - docker build --target runner -t curacel-people-app:latest .
          
          # 3. Save Image for Transfer
          - echo "Saving image for transfer..."
          - docker save curacel-people-app:latest | gzip > app_image.tar.gz
          
          # 4. Prepare Environment File (Local expansion)
          - echo "Preparing .env file..."
          - |
            cat << ENVEOF > .env
            NODE_ENV=production
            PORT=3800
            DATABASE_URL=$DATABASE_URL
            NEXTAUTH_SECRET=$NEXTAUTH_SECRET
            NEXTAUTH_URL=$NEXTAUTH_URL
            GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID
            GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET
            POSTMARK_SERVER_TOKEN=${POSTMARK_SERVER_TOKEN:-$POSTMARK_API_TOKEN}
            POSTMARK_API_TOKEN=${POSTMARK_API_TOKEN:-$POSTMARK_SERVER_TOKEN}
            POSTMARK_FROM=${POSTMARK_FROM:-$EMAIL_FROM}
            POSTMARK_MESSAGE_STREAM=${POSTMARK_MESSAGE_STREAM:-outbound}
            SMTP_HOST=${SMTP_HOST:-$EMAIL_SERVER_HOST}
            SMTP_PORT=${SMTP_PORT:-${EMAIL_SERVER_PORT:-587}}
            SMTP_USER=${SMTP_USER:-${EMAIL_SERVER_USER:-$SMTP_USERNAME}}
            SMTP_PASSWORD=${SMTP_PASSWORD:-${EMAIL_SERVER_PASSWORD:-$SMTP_PASS}}
            EMAIL_FROM=${EMAIL_FROM:-$POSTMARK_FROM}
            EMAIL_SERVER_HOST=${EMAIL_SERVER_HOST:-$SMTP_HOST}
            EMAIL_SERVER_PORT=${EMAIL_SERVER_PORT:-${SMTP_PORT:-587}}
            EMAIL_SERVER_USER=${EMAIL_SERVER_USER:-${SMTP_USER:-$SMTP_USERNAME}}
            EMAIL_SERVER_PASSWORD=${EMAIL_SERVER_PASSWORD:-${SMTP_PASSWORD:-$SMTP_PASS}}
            DOCUSIGN_CLIENT_ID=$DOCUSIGN_CLIENT_ID
            DOCUSIGN_CLIENT_SECRET=$DOCUSIGN_CLIENT_SECRET
            DOCUSIGN_REDIRECT_URI=$DOCUSIGN_REDIRECT_URI
            UPLOADTHING_SECRET=$UPLOADTHING_SECRET
            UPLOADTHING_APP_ID=$UPLOADTHING_APP_ID
            ENCRYPTION_KEY=$ENCRYPTION_KEY
            DEV_PASSWORDLESS_LOGIN=$DEV_PASSWORDLESS_LOGIN
            DEV_AUTO_CREATE_SUPER_ADMIN=$DEV_AUTO_CREATE_SUPER_ADMIN
            NEXT_PUBLIC_DEV_PASSWORDLESS_LOGIN=$DEV_PASSWORDLESS_LOGIN
            NEXT_PUBLIC_APP_URL=$NEXTAUTH_URL
            ENVEOF

          # 5. Transfer files to Server
          - echo "Transferring artifacts to server..."
          # First ensure directory exists
          - ssh -o StrictHostKeyChecking=no -i ~/.ssh/pipelines_id $SSH_USER@$SSH_HOST "mkdir -p ~/peopleos"
          # Transfer compose file and artifacts
          - scp -o StrictHostKeyChecking=no -i ~/.ssh/pipelines_id .env docker-compose.deploy.yml app_image.tar.gz $SSH_USER@$SSH_HOST:~/peopleos/

          # 6. Remote Deployment (Near-Zero Downtime Swap)
          - echo "Completing deployment on server..."
          - |
            ssh -o StrictHostKeyChecking=no -i ~/.ssh/pipelines_id $SSH_USER@$SSH_HOST bash << 'EOF'
              cd ~/peopleos
              echo "--- Starting Remote Deployment ---"
              
              # 1. Load New Image
              echo "[1/4] Loading image from tarball..."
              if [ -f app_image.tar.gz ]; then
                gunzip -c app_image.tar.gz | docker load
              else
                echo "Error: app_image.tar.gz not found!"
              fi

              # 2. Infra Warm-up
              echo "[2/4] Ensuring DB and Redis are running..."
              docker compose -f docker-compose.deploy.yml up -d postgres redis
              
              echo "Waiting for DB to be ready..."
              sleep 10
              docker exec curacel-people-db-v2 pg_isready -U curacel -d curacel_people || echo "DB not ready yet, proceeding anyway..."

              # 3. Skip migrations - DB is already in sync
              echo "[3/4] Skipping migrations (database already synced)"

              # 4. App Swap
              docker compose -f docker-compose.deploy.yml up -d --force-recreate app adminer

              # Ensure Docker socket is accessible for the system logs feature
              echo "Ensuring Docker socket accessibility for system logs..."
              sudo chmod 666 /var/run/docker.sock || echo "Warning: Could not chmod docker.sock. System logs might have permission issues."

              echo "--- Post-Deployment Summary ---"
              sleep 15
              echo "Container Status:"
              docker compose -f docker-compose.deploy.yml ps
              
              echo "App Logs (Last 60 lines):"
              docker logs curacel-people-app-v2 --tail 60
              
              echo "Local Health Check:"
              curl -s -I http://localhost:3800 | grep "HTTP/" || echo "❌ App not responding on port 3800"

              # Cleanup
              rm -f app_image.tar.gz
              docker image prune -f
              echo "✅ Deployment finished."
            EOF

  default:
    - step:
        name: Test Build
        services:
          - docker
        caches:
          - node
        script:
          - echo "Testing Next.js build..."
          - npm ci --legacy-peer-deps
          - npx -y prisma@5.10.2 generate
          - NODE_OPTIONS=--max-old-space-size=4096 npm run build
          - echo "✓ Build successful!"

  pull-requests:
    '**':
      - step:
          name: Test Build
          services:
            - docker
          caches:
            - node
          script:
            - echo "Testing Next.js build..."
            - npm ci --legacy-peer-deps
            - npx -y prisma@5.10.2 generate
            - NODE_OPTIONS=--max-old-space-size=4096 npm run build
            - echo "✓ Build successful!"