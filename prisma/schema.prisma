// Prisma schema for Curacel People

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// AUTH & USER MANAGEMENT
// ============================================

enum Role {
  SUPER_ADMIN
  HR_ADMIN
  IT_ADMIN
  MANAGER
  EMPLOYEE
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  image         String?
  role          Role      @default(EMPLOYEE)
  employeeId    String?   @unique
  employee      Employee? @relation(fields: [employeeId], references: [id])

  passwordHash  String?
  passwordSetAt DateTime?

  resetToken        String?   @unique
  resetTokenExpires DateTime?

  emailVerified DateTime?
  accounts      Account[]
  sessions      Session[]
  
  // Audit tracking
  auditLogs     AuditLog[]
  notifications Notification[]
  aiChats       AIChat[]

  invitesSent   UserInvite[] @relation("InvitedBy")
  apiTokens     ApiToken[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}


model UserInvite {
  id          String   @id @default(cuid())
  email       String
  role        Role
  token       String   @unique
  expiresAt   DateTime
  acceptedAt  DateTime?
  revokedAt   DateTime?

  invitedById String
  invitedBy   User     @relation("InvitedBy", fields: [invitedById], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([email])
  @@index([invitedById])
}

model ApiToken {
  id          String   @id @default(uuid())
  name        String
  tokenHash   String   @unique
  tokenPrefix String
  lastUsedAt  DateTime?
  revokedAt   DateTime?

  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([createdById])
  @@index([revokedAt])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? 
  access_token      String? 
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? 
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// EMPLOYEE MANAGEMENT
// ============================================

enum EmployeeStatus {
  CANDIDATE
  OFFER_SENT
  OFFER_SIGNED
  HIRED_PENDING_START
  ACTIVE
  OFFBOARDING
  EXITED
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACTOR
  INTERN
}

enum ContractType {
  PERMANENT
  FIXED_TERM
  CONTRACTOR
  INTERN
}

model Employee {
  id              String          @id @default(uuid())
  fullName        String
  personalEmail   String          @unique
  workEmail       String?         @unique
  status          EmployeeStatus  @default(CANDIDATE)

  // Link to candidate record
  candidateId     String?         @unique
  candidate       JobCandidate?   @relation("EmployeeCandidate", fields: [candidateId], references: [id], onDelete: SetNull)

  // Company stage flow (employee lifecycle tracking)
  companyStageFlowSnapshotId String?
  companyStageFlowSnapshot   CompanyStageFlowSnapshot? @relation("EmployeeStageFlow", fields: [companyStageFlowSnapshotId], references: [id])

  // Job details
  jobTitle        String?
  department      String?
  managerId       String?
  manager         Employee?       @relation("ManagerReports", fields: [managerId], references: [id])
  directReports   Employee[]      @relation("ManagerReports")
  location        String?
  employmentType  EmploymentType  @default(FULL_TIME)

  // Dates
  startDate        DateTime?
  endDate          DateTime?
  probationEndDate DateTime?
  onboardedAt      DateTime?
  offboardedAt     DateTime?

  // HR/PII fields (encrypted at rest)
  salaryAmount    Decimal?        @db.Decimal(12, 2)
  salaryCurrency  String?         @default("USD")
  contractType    ContractType?
  
  // Address
  addressStreet   String?
  addressCity     String?
  addressState    String?
  addressPostal   String?
  addressCountry  String?
  
  // Contact
  phone           String?
  profileImageUrl String?
  
  // Personal details
  gender          String?
  maritalStatus   String?
  dateOfBirth     DateTime?
  nationality     String?
  taxId           String?
  
  // Bank details
  bankName        String?
  accountName     String?
  accountNumber   String?
  accountSortCode String?
  
  // Emergency contact
  emergencyContactName     String?
  emergencyContactRelation String?
  emergencyContactPhone    String?
  emergencyContactEmail    String?

  // Personality & Values (collected during onboarding)
  lifeValues               Json?    // { mostImportant: [], important: [], somewhatImportant: [], notImportant: [] }
  knowAboutMe              Json?    // Array of { question, answer } for work style questions
  mbtiType                 String?  // Myers-Briggs Type Indicator (e.g., INTJ, ENFP)
  mbtiImageUrl             String?  // Optional uploaded MBTI result image
  bigFiveUrl               String?  // URL to Big Five test results
  bigFiveImageUrl          String?  // Optional uploaded Big Five result image
  personalityCompleted     Boolean  @default(false)
  personalityCompletedAt   DateTime?

  // Former Employment (full-time employees only)
  formerOfferLetterUrl           String?
  formerLastPayslipUrl           String?
  formerResignationLetterUrl     String?
  formerResignationConfirmUrl    String?
  formerHrContactName            String?
  formerHrContactPhone           String?
  formerHrContactEmail           String?
  formerCompanyAddress           String?
  formerEmploymentSubmittedAt    DateTime?

  // Flexible metadata
  meta            Json?
  
  // Relations
  user            User?
  offers          Offer[]
  appAccounts     AppAccount[]
  onboardingWorkflows OnboardingWorkflow[]
  offboardingWorkflows OffboardingWorkflow[]

  // Recruiting relations
  managedJobs     Job[]           @relation("JobHiringManager")
  followedJobs    JobFollower[]   @relation("JobFollowers")
  addedCandidates JobCandidate[]  @relation("CandidatesAddedBy")
  interviewQuestions InterviewQuestion[]

  // V2 competency framework
  competencyAssessments EmployeeCompetencyScore[]

  // Role history tracking
  roleHistory       EmployeeRoleHistory[]
  emergencyContacts EmergencyContact[]

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([status])
  @@index([department])
  @@index([managerId])
  @@index([candidateId])
  @@index([companyStageFlowSnapshotId])
}

// Track employee role changes, promotions, and progression
model EmployeeRoleHistory {
  id              String    @id @default(uuid())
  employeeId      String
  employee        Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  // Role change details
  fromJobTitle    String?
  toJobTitle      String
  fromDepartment  String?
  toDepartment    String?
  fromSalary      Decimal?  @db.Decimal(12, 2)
  toSalary        Decimal?  @db.Decimal(12, 2)
  changeType      String    // "PROMOTION", "LATERAL_MOVE", "DEMOTION", "DEPARTMENT_CHANGE"
  reason          String?   @db.Text

  // When the change took effect
  effectiveDate   DateTime
  notes           String?   @db.Text

  createdAt       DateTime  @default(now())
  createdBy       String?   // User/Employee ID who made the change

  @@index([employeeId, effectiveDate])
}

model EmergencyContact {
  id           String   @id @default(uuid())
  employeeId   String
  employee     Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  name         String
  phone        String?
  email        String?
  relationship String?
  isPrimary    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([employeeId])
}

// ============================================
// OFFERS & CONTRACTS
// ============================================

enum OfferStatus {
  DRAFT
  SENT
  VIEWED
  SIGNED
  DECLINED
  EXPIRED
  CANCELLED
}

model OfferTemplate {
  id              String    @id @default(uuid())
  name            String
  description     String?
  bodyHtml        String    
  bodyMarkdown    String?   
  
  // Employment type this template is for
  employmentType  EmploymentType?
  
  // Standard attachments
  includeNda      Boolean   @default(true)
  includePii      Boolean   @default(true)
  
  // Custom attachments
  attachments     OfferTemplateAttachment[]
  
  // Variable schema (JSON describing expected variables)
  variableSchema  Json?

  isActive        Boolean   @default(true)
  offers          Offer[]
  jobsAsDefault   Job[]     @relation("JobDefaultTemplate")

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model OfferTemplateAttachment {
  id              String        @id @default(uuid())
  templateId      String
  template        OfferTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  name            String
  type            String        // "nda", "pii", "custom"
  contentHtml     String?       
  fileUrl         String?
  
  createdAt       DateTime      @default(now())
}

model Offer {
  id              String        @id @default(uuid())
  
  // Candidate info
  employeeId      String
  employee        Employee      @relation(fields: [employeeId], references: [id])
  candidateEmail  String
  candidateName   String
  
  // Template
  templateId      String
  template        OfferTemplate @relation(fields: [templateId], references: [id])
  
  // Filled variables
  variables       Json          // { role: "Engineer", salary: "100000", etc. }
  
  // Rendered content (snapshot at send time)
  renderedHtml    String?       
  
  // Status
  status          OfferStatus   @default(DRAFT)
  
  // E-signature tracking
  esignEnvelopeId String?       @unique
  esignProvider   String?       // "docusign"
  esignStatus     String?
  esignSentAt     DateTime?
  esignViewedAt   DateTime?
  esignSignedAt   DateTime?
  esignDeclinedAt DateTime?
  esignExpiresAt  DateTime?
  
  // Signed document
  signedDocUrl    String?
  
  // Timeline events
  events          OfferEvent[]
  
  // Metadata
  sentBy          String?       // User ID who sent
  notes           String?
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([status])
  @@index([candidateEmail])
}

model OfferEvent {
  id          String   @id @default(uuid())
  offerId     String
  offer       Offer    @relation(fields: [offerId], references: [id], onDelete: Cascade)
  type        String   // "created", "sent", "viewed", "signed", "declined", "expired"
  description String?
  metadata    Json?
  occurredAt  DateTime @default(now())
}

// ============================================
// APP INTEGRATIONS
// ============================================

enum AppType {
  GOOGLE_WORKSPACE
  SLACK
  BITBUCKET
  JIRA
  PASSBOLT
  HUBSPOT
  STANDUPNINJA
  FIREFLIES
  WEBFLOW
  CUSTOM
}

enum ConnectionTestStatus {
  SUCCESS
  FAILED
}

model App {
  id              String          @id @default(uuid())
  type            AppType
  name            String
  description     String?
  iconUrl         String?
  isEnabled       Boolean         @default(true)
  archivedAt      DateTime?
  
  connections     AppConnection[]
  provisioningRules AppProvisioningRule[]
  accounts        AppAccount[]
  onboardingTaskTemplates OnboardingTaskTemplate[]
  offboardingTaskTemplates OffboardingTaskTemplate[]
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@unique([type, name])
  @@index([type])
  @@index([archivedAt])
}

model AppConnection {
  id              String    @id @default(uuid())
  appId           String
  app             App       @relation(fields: [appId], references: [id])

  // Connection config (encrypted)
  configEncrypted String

  // Domain/workspace identifier
  domain          String?

  isActive        Boolean   @default(true)
  lastSyncAt      DateTime?
  lastTestStatus  ConnectionTestStatus?
  lastTestedAt    DateTime?
  lastTestError   String?

  // Webflow field mapping (for Webflow integrations)
  webflowFieldMapping WebflowFieldMapping?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([appId, domain])
}

model AppProvisioningRule {
  id              String    @id @default(uuid())
  appId           String
  app             App       @relation(fields: [appId], references: [id])
  
  name            String
  description     String?
  
  // Condition (JSON) - e.g. { "department": "Engineering", "location": "Remote" }
  condition       Json
  
  // Provision data (JSON) - e.g. { "groups": ["eng-team"], "channels": ["#engineering"] }
  provisionData   Json
  
  priority        Int       @default(0)
  isActive        Boolean   @default(true)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([appId, isActive])
}

enum AppAccountStatus {
  PENDING
  PROVISIONING
  ACTIVE
  FAILED
  DISABLED
  DEPROVISIONED
}

model AppAccount {
  id              String          @id @default(uuid())
  employeeId      String
  employee        Employee        @relation(fields: [employeeId], references: [id])
  appId           String
  app             App             @relation(fields: [appId], references: [id])

  // External account info
  externalUserId  String?
  externalEmail   String?
  externalUsername String?

  status          AppAccountStatus @default(PENDING)
  statusMessage   String?

  // Provisioned resources (JSON) - e.g. { "groups": [...], "channels": [...] }
  provisionedResources Json?

  lastSyncAt      DateTime?
  provisionedAt   DateTime?
  deprovisionedAt DateTime?

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@unique([employeeId, appId])
  @@index([status])
}

// Webflow CMS field mapping for job publishing
model WebflowFieldMapping {
  id              String        @id @default(uuid())
  appConnectionId String        @unique
  appConnection   AppConnection @relation(fields: [appConnectionId], references: [id], onDelete: Cascade)

  // Field mappings: { "title": "name", "department": "category", ... }
  fieldMappings   Json

  // Cached Webflow collection schema
  collectionSchema Json?
  schemaFetchedAt DateTime?

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
}

// ============================================
// ONBOARDING
// ============================================

enum WorkflowStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
  CANCELLED
}

model OnboardingWorkflow {
  id              String          @id @default(uuid())
  employeeId      String
  employee        Employee        @relation(fields: [employeeId], references: [id])
  
  status          WorkflowStatus  @default(PENDING)
  startedAt       DateTime?
  completedAt     DateTime?
  
  // Token for employee self-service
  accessToken     String          @unique @default(uuid())
  accessTokenExpiresAt DateTime?
  
  tasks           OnboardingTask[]
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([employeeId])
  @@index([status])
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  SUCCESS
  FAILED
  SKIPPED
}

enum TaskType {
  AUTOMATED
  MANUAL
}

model OnboardingTask {
  id              String              @id @default(uuid())
  workflowId      String
  workflow        OnboardingWorkflow  @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  
  name            String
  description     String?
  type            TaskType
  status          TaskStatus          @default(PENDING)
  
  // For automated tasks
  automationType  String?             // "provision_google", "provision_slack", etc.
  automationConfig Json?
  
  // Execution details
  statusMessage   String?
  attempts        Int                 @default(0)
  lastAttemptAt   DateTime?
  completedAt     DateTime?
  completedBy     String?             // User ID for manual tasks
  
  // Order
  sortOrder       Int                 @default(0)
  
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([workflowId, status])
}

// ============================================
// OFFBOARDING
// ============================================

model OffboardingWorkflow {
  id              String          @id @default(uuid())
  employeeId      String
  employee        Employee        @relation(fields: [employeeId], references: [id])
  
  status          WorkflowStatus  @default(PENDING)
  scheduledFor    DateTime?       // For scheduled offboarding
  isImmediate     Boolean         @default(false)
  startedAt       DateTime?
  completedAt     DateTime?
  
  reason          String?
  notes           String?
  googleDeleteAccount Boolean      @default(false)
  googleTransferToEmail String?
  googleTransferApps Json?
  googleAliasToEmail String?
  initiatedBy     String?         // User ID
  
  tasks           OffboardingTask[]
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([employeeId])
  @@index([status])
  @@index([scheduledFor])
}

model OffboardingTask {
  id              String              @id @default(uuid())
  workflowId      String
  workflow        OffboardingWorkflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  
  name            String
  description     String?
  type            TaskType
  status          TaskStatus          @default(PENDING)
  
  // For automated tasks
  automationType  String?             // "deprovision_google", "deprovision_slack", etc.
  appId           String?             // Reference to which app to deprovision
  
  // Execution details
  statusMessage   String?
  attempts        Int                 @default(0)
  lastAttemptAt   DateTime?
  completedAt     DateTime?
  completedBy     String?
  
  sortOrder       Int                 @default(0)
  
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([workflowId, status])
}

// ============================================
// AUDIT LOG
// ============================================

enum AuditAction {
  // Offers
  OFFER_CREATED
  OFFER_UPDATED
  OFFER_SENT
  OFFER_VIEWED
  OFFER_SIGNED
  OFFER_DECLINED
  OFFER_CANCELLED
  OFFER_WEBHOOK_RECEIVED
  
  // Employees
  EMPLOYEE_CREATED
  EMPLOYEE_UPDATED
  EMPLOYEE_STATUS_CHANGED
  BULK_UPDATE
  BULK_DELETE
  
  // Onboarding
  ONBOARDING_STARTED
  ONBOARDING_TASK_COMPLETED
  ONBOARDING_COMPLETED
  
  // Offboarding
  OFFBOARDING_STARTED
  OFFBOARDING_TASK_COMPLETED
  OFFBOARDING_COMPLETED
  
  // Integrations
  APP_CREATED
  APP_ARCHIVED
  APP_RESTORED
  APP_CONNECTED
  APP_DISCONNECTED
  APP_ACCOUNT_PROVISIONED
  APP_ACCOUNT_DEPROVISIONED
  GOOGLE_USER_CREATED
  GOOGLE_USER_DISABLED
  GOOGLE_USER_DELETED
  GOOGLE_GROUPS_UPDATED
  SLACK_USER_CREATED
  SLACK_USER_DISABLED
  SLACK_CHANNELS_UPDATED
  
  // Settings
  PROVISIONING_RULE_CREATED
  PROVISIONING_RULE_UPDATED
  PROVISIONING_RULE_DELETED

  // Auth
  USER_LOGIN
  USER_LOGOUT

  // AI Assistant
  ASSISTANT_ACTION

  // Candidate Lifecycle
  CANDIDATE_STAGE_CHANGED
  CANDIDATE_STAGE_EMAIL_QUEUED
  CANDIDATE_STAGE_EMAIL_SKIPPED
  CANDIDATE_RESUME_PARSED
}

enum NotificationRecipientMode {
  ALL_ADMINS
  INITIATOR
  SELECTED
}

model AuditLog {
  id            String      @id @default(uuid())
  
  // Actor
  actorId       String?
  actor         User?       @relation(fields: [actorId], references: [id])
  actorEmail    String?
  actorType     String?     // "user", "system", "webhook"
  
  // Action
  action        AuditAction
  
  // Resource
  resourceType  String      // "employee", "offer", "app_account", etc.
  resourceId    String?
  
  // Details
  metadata      Json?
  ipAddress     String?
  userAgent     String?
  
  createdAt     DateTime    @default(now())

  @@index([action])
  @@index([resourceType, resourceId])
  @@index([actorId])
  @@index([createdAt])

  notifications Notification[]
}

model Notification {
  id            String      @id @default(uuid())
  userId        String
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  auditLogId    String?
  auditLog      AuditLog?   @relation(fields: [auditLogId], references: [id], onDelete: SetNull)
  action        AuditAction
  resourceType  String
  resourceId    String?
  actorName     String?
  actorEmail    String?
  readAt        DateTime?
  archivedAt    DateTime?
  createdAt     DateTime    @default(now())

  @@index([userId, readAt])
  @@index([userId, archivedAt])
  @@index([createdAt])
}

// ============================================
// BACKGROUND JOBS (for pg-boss tracking)
// ============================================

model JobExecution {
  id          String    @id @default(uuid())
  jobName     String
  jobId       String?
  status      String    // "pending", "running", "completed", "failed"
  input       Json?
  output      Json?
  error       String?
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime  @default(now())

  @@index([jobName, status])
  @@index([createdAt])
}

// ============================================
// ORGANIZATION SETTINGS
// ============================================

model Organization {
  id                    String    @id @default(uuid())
  name                  String
  logoUrl               String?
  oneSentenceDescription String?
  careerPageUrl         String?
  detailedDescription   String?   // Rich text HTML
  letterheadEmail       String?
  letterheadWebsite     String?
  letterheadAddress     String?
  letterheadPhone       String?
  googleWorkspaceTransferToEmail String?
  notificationEmailEnabled Boolean  @default(true)
  notificationEmailActions Json?
  notificationEmailRecipients Json?
  notificationEmailRecipientMode NotificationRecipientMode @default(ALL_ADMINS)
  sidebarBadgesEnabled  Boolean  @default(true)
  sidebarBadgeSettings  Json?    // { openJobs: true, activeCandidates: true, activeEmployees: true, pendingContracts: true, inProgressOnboarding: true, inProgressOffboarding: true }

  // Public Pages Settings - controls which public portals are enabled
  publicPageSettings    Json?    // { careers: { enabled: true }, apply: { enabled: true }, assessment: { enabled: true }, recruiter: { enabled: true }, interview: { enabled: true }, offer: { enabled: true }, onboarding: { enabled: true }, apiDocs: { enabled: true }, auth: { enabled: true } }

  legalEntities         LegalEntity[]
  onboardingTaskTemplates OnboardingTaskTemplate[]
  offboardingTaskTemplates OffboardingTaskTemplate[]
  offboardingEmployeeTasks OffboardingEmployeeTask[]
  
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@unique([id])
}

model LegalEntity {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name           String
  address        String?
  country        String?
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([organizationId, name])
  @@index([organizationId, isActive])
}

// External advisors who can be assigned as interviewers but aren't employees
model Advisor {
  id             String       @id @default(uuid())
  fullName       String
  email          String       @unique
  title          String?      // e.g., "Technical Advisor", "Executive Recruiter"
  company        String?      // Their company/affiliation
  phone          String?
  notes          String?
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([email])
  @@index([isActive])
}

model Team {
  id             String       @id @default(uuid())
  name           String       @unique
  description    String?
  color          String?      // Hex color for UI display
  leaderId       String?      // Employee ID of team lead

  // Sub-team support
  parentId       String?
  parent         Team?        @relation("TeamHierarchy", fields: [parentId], references: [id])
  subTeams       Team[]       @relation("TeamHierarchy")

  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([name])
  @@index([isActive])
  @@index([parentId])
}

model OnboardingTaskTemplate {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  name           String
  description    String?
  type           TaskType
  automationType String?
  appId          String?
  app            App?         @relation(fields: [appId], references: [id])
  appType        AppType?
  sortOrder      Int          @default(0)
  isActive       Boolean      @default(true)

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId, sortOrder])
  @@index([organizationId, isActive])
  @@index([organizationId, appId])
}

model OffboardingTaskTemplate {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  name           String
  description    String?
  type           TaskType
  automationType String?
  appId          String?
  app            App?         @relation(fields: [appId], references: [id])
  appType        AppType?
  sortOrder      Int          @default(0)
  isActive       Boolean      @default(true)

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId, sortOrder])
  @@index([organizationId, isActive])
  @@index([organizationId, appId])
}

model OffboardingEmployeeTask {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  name           String
  description    String?
  sortOrder      Int          @default(0)
  isActive       Boolean      @default(true)

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId, sortOrder])
  @@index([organizationId, isActive])
}

// ============================================
// SIGNATURE BLOCKS
// ============================================

model SignatureBlock {
  id              String    @id @default(uuid())
  signatoryName   String
  signatoryTitle  String
  signatureText   String?   // Electronic signature text (full name as signature)
  signatureImageUrl String? // URL to uploaded signature image
  isDefault       Boolean   @default(false)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([signatoryName])
}

// ============================================
// AI ASSISTANT SETTINGS
// ============================================

enum AIProvider {
  OPENAI
  ANTHROPIC
  GEMINI
}

enum AIChatRole {
  USER
  ASSISTANT
}

model AISettings {
  id                    String      @id @default(uuid())

  // Provider selection
  provider              AIProvider  @default(OPENAI)

  // API keys (encrypted)
  openaiKeyEncrypted    String?
  anthropicKeyEncrypted String?
  geminiKeyEncrypted    String?

  // Model selection
  openaiModel           String      @default("gpt-4o")
  anthropicModel        String      @default("claude-sonnet-4-20250514")
  geminiModel           String      @default("gemini-2.0-flash")

  // System prompt
  systemPrompt          String?     @db.Text

  // Feature flags
  isEnabled             Boolean     @default(true)
  requireConfirmation   Boolean     @default(true)

  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
}

model AIChat {
  id        String        @id @default(uuid())
  userId    String
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String        @default("New chat")
  messages  AIChatMessage[]
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@index([userId, updatedAt])
}

model AIChatMessage {
  id        String     @id @default(uuid())
  chatId    String
  chat      AIChat     @relation(fields: [chatId], references: [id], onDelete: Cascade)
  role      AIChatRole
  content   String
  isError   Boolean    @default(false)
  createdAt DateTime   @default(now())

  @@index([chatId, createdAt])
}

// Custom AI Tools - Dynamic function calling
model AICustomTool {
  id              String   @id @default(uuid())
  name            String   @unique // Function name (e.g., "archive_candidate")
  displayName     String   // Human-readable name
  description     String   @db.Text
  category        String   // e.g., "hiring", "contracts", "employees"

  // OpenAI function calling schema
  parameters      Json     // JSON schema for function parameters

  // Execution configuration
  executionType   String   // "trpc_mutation", "trpc_query", "webhook", "custom_code"
  executionConfig Json     // Configuration for execution (e.g., tRPC path, webhook URL)

  // Permissions and safety
  requiresConfirmation Boolean @default(false)
  allowedRoles    Json?    // Array of roles that can use this tool

  // Status
  isActive        Boolean  @default(true)
  isBuiltIn       Boolean  @default(false) // True for system tools, false for custom

  // Auto-creation and approval workflow
  autoCreated     Boolean  @default(false) // True if created by AuntyPelz
  approvalStatus  ApprovalStatus? // PENDING, APPROVED, REJECTED for auto-created tools
  approvedBy      String?  // User ID who approved/rejected
  approvedAt      DateTime?
  rejectionReason String?  @db.Text
  sourceContext   String?  @db.Text // The user request that triggered auto-creation

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdBy       String?

  jobs            JobAction[]

  @@index([category, isActive])
  @@index([isActive, isBuiltIn])
  @@index([approvalStatus])
  @@index([autoCreated])
}

// V3: Approval workflow for bulk/destructive actions
enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}

model AssistantApproval {
  id          String         @id @default(uuid())
  orgId       String
  userId      String
  planId      String         @unique
  toolName    String
  dryRunData  Json           // What will change
  status      ApprovalStatus @default(PENDING)
  approvedAt  DateTime?
  approvedBy  String?
  expiresAt   DateTime
  createdAt   DateTime       @default(now())

  @@index([userId, status])
  @@index([expiresAt])
}

// V3: Daily brief summaries for proactive assistant
model DailyBrief {
  id        String   @id @default(uuid())
  orgId     String
  date      DateTime @db.Date
  summary   Json     // { pendingContracts, upcomingStarts, stuckWorkflows }
  createdAt DateTime @default(now())

  @@unique([orgId, date])
  @@index([orgId, date])
}

// ============================================
// ONBOARDING SETTINGS
// ============================================

model OnboardingSettings {
  id                String   @id @default(uuid())
  sheetId           String?  // Google Sheet ID for tracking employee tasks
  sheetRosterRange  String   @default("Status!A2:J")
  sheetRefreshMs    Int      @default(30000)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

// ============================================
// HIRING FLOWS
// ============================================

// Master hiring flow definition (editable in settings)
model HiringFlow {
  id          String   @id @default(uuid())
  name        String   @unique  // "Standard", "Engineering", "Sales"
  description String?
  stages      Json     // Array of stage names: ["Apply", "People Chat", "Assessment", "Team Chat", "Trial", "CEO Chat", "Offer"]
  isDefault   Boolean  @default(false)
  isActive    Boolean  @default(true)

  // Track all snapshots of this flow
  snapshots   HiringFlowSnapshot[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive])
  @@index([isDefault])
}

// Immutable snapshot of a flow at a point in time
model HiringFlowSnapshot {
  id          String      @id @default(uuid())
  flowId      String
  flow        HiringFlow  @relation(fields: [flowId], references: [id], onDelete: Cascade)

  version     Int         // Auto-incrementing per flow
  stages      Json        // Frozen copy of stages at snapshot time
  snapshotAt  DateTime    @default(now())

  // Jobs using this snapshot
  jobs        Job[]

  @@unique([flowId, version])
  @@index([flowId])
}

// ============================================
// COMPANY STAGE PROCESS (Employee Lifecycle)
// ============================================

// Master company stage flow definition (editable in settings)
model CompanyStageFlow {
  id          String   @id @default(uuid())
  name        String   @unique  // "Standard", "Executive", "Contractor"
  description String?
  stages      Json     // Array of stage names: ["Applied", "Interviewed", "Offered", "Onboarding", "Active", "Promoted", "Transferred", "Performance Review", "Exit Process", "Alumni"]
  isDefault   Boolean  @default(false)
  isActive    Boolean  @default(true)

  // Track all snapshots of this flow
  snapshots   CompanyStageFlowSnapshot[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive])
  @@index([isDefault])
}

// Immutable snapshot of a company stage flow at a point in time
model CompanyStageFlowSnapshot {
  id          String           @id @default(uuid())
  flowId      String
  flow        CompanyStageFlow @relation(fields: [flowId], references: [id], onDelete: Cascade)

  version     Int              // Auto-incrementing per flow
  stages      Json             // Frozen copy of stages at snapshot time
  snapshotAt  DateTime         @default(now())

  // Employees using this snapshot
  employees   Employee[]       @relation("EmployeeStageFlow")

  @@unique([flowId, version])
  @@index([flowId])
}

// ============================================
// JOB SETTINGS - JDs, RUBRICS, COMPETENCIES
// ============================================

model JobDescription {
  id          String   @id @default(uuid())
  name        String   // e.g., "Senior Backend Engineer"
  department  String?  // Team/department name
  content     String   @db.Text // Full JD content in markdown/HTML
  version     Int      @default(1)
  isActive    Boolean  @default(true)

  jobs        Job[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([name])
  @@index([department])
  @@index([isActive])
}

model HiringRubric {
  id          String           @id @default(uuid())
  name        String           // e.g., "Engineering Technical Assessment"
  description String?
  version     Int              @default(1)
  isActive    Boolean          @default(true)
  criteria    RubricCriteria[]

  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([name])
  @@index([isActive])
}

model RubricCriteria {
  id          String       @id @default(uuid())
  rubricId    String
  rubric      HiringRubric @relation(fields: [rubricId], references: [id], onDelete: Cascade)

  name        String       // e.g., "Technical Skills"
  description String?
  weight      Int          @default(1) // Weight for scoring (1-5)
  sortOrder   Int          @default(0)

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([rubricId, sortOrder])
}

// Legacy simple competency model (to be deprecated)
model Competency {
  id          String   @id @default(uuid())
  name        String   // e.g., "Technical Excellence"
  description String?
  category    String   // e.g., "Technical", "Leadership", "Communication"
  isActive    Boolean  @default(true)

  jobs        JobCompetency[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([name, category])
  @@index([category])
  @@index([isActive])
}

// ============================================
// COMPETENCY FRAMEWORK V2 (Google Sheets-based)
// ============================================

// Competency framework sources - each department or framework type
model CompetencyFrameworkSource {
  id                String   @id @default(uuid())
  type              String   // "DEPARTMENT", "AI", "VALUES"
  name              String   // "Engineering", "Sales", "AI Framework", "Company Values"
  department        String?  // For DEPARTMENT type only (e.g., "Engineering")

  // Google Sheets integration
  sheetUrl          String   // Full Google Sheets URL
  sheetId           String   // Extracted sheet ID from URL
  gidOrTabName      String?  // Specific tab/gid if multi-tab sheet

  // Detected format configuration
  formatType        String   // "STANDARD_4_LEVEL", "EXTENDED_5_LEVEL", "AI_BEHAVIORAL"
  levelNames        Json     // ["Basic", "Intermediate", "Proficient", "Advanced"] or with "Expert"
  minLevel          Int      @default(1)  // 0 for AI (Unacceptable), 1 for others
  maxLevel          Int      // 4 or 5 depending on framework

  // Sync metadata
  lastSyncedAt      DateTime?
  lastSyncStatus    String?  // "SUCCESS", "FAILED", "PENDING"
  lastSyncError     String?  @db.Text
  cacheValidUntil   DateTime? // Cache expiry (30 days from last sync)
  syncedByUserId    String?

  // Structure metadata (stored from sheet for parser)
  columnMapping     Json?    // Map column letters to data types

  isActive          Boolean  @default(true)

  // Relations
  coreCompetencies  CoreCompetency[]
  syncLogs          CompetencySyncLog[]

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([type, department])
  @@index([type])
  @@index([lastSyncedAt])
  @@index([cacheValidUntil])
}

// Core competencies - high-level competency areas
model CoreCompetency {
  id                String   @id @default(uuid())
  sourceId          String
  source            CompetencyFrameworkSource @relation(fields: [sourceId], references: [id], onDelete: Cascade)

  name              String   // e.g., "Employee Experience", "AI Tool Proficiency", "Passionate Work"
  description       String?  @db.Text
  functionArea      String?  // e.g., "People Operations" (from Function column)
  category          String?  // Grouping category

  sortOrder         Int      @default(0)

  // Relations
  subCompetencies   SubCompetency[]

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([sourceId, sortOrder])
}

// Sub-competencies - specific skills with level descriptions
model SubCompetency {
  id                String   @id @default(uuid())
  coreCompetencyId  String
  coreCompetency    CoreCompetency @relation(fields: [coreCompetencyId], references: [id], onDelete: Cascade)

  name              String   // e.g., "Employee engagement approaches", "Frontend Development"
  description       String?  @db.Text

  // Level descriptions from Google Sheets (flexible for 4 or 5 levels)
  // Stored as: { "1": "Basic description...", "2": "Intermediate...", etc. }
  levelDescriptions Json     @db.Json

  // For AI competencies with behavioral indicators (checkbox-based)
  hasBehavioralIndicators Boolean @default(false)
  behavioralIndicators    Json?   @db.Json // { "1": ["indicator1", "indicator2"], "2": [...], ... }

  sortOrder         Int      @default(0)
  isActive          Boolean  @default(true)

  // Relations
  candidateScores   CandidateCompetencyScore[]
  employeeScores    EmployeeCompetencyScore[]
  jobRequirements   JobCompetencyRequirement[]

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([coreCompetencyId, sortOrder])
  @@index([isActive])
}

// Job competency requirements - what's needed for a role
model JobCompetencyRequirement {
  id                String   @id @default(uuid())
  jobId             String
  job               Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  subCompetencyId   String
  subCompetency     SubCompetency @relation(fields: [subCompetencyId], references: [id], onDelete: Cascade)

  // Required level for this role (raw score from framework: 1-4 or 1-5)
  requiredLevel     Int      // 1-5 depending on framework
  requiredLevelName String   // "Basic", "Intermediate", "Proficient", "Advanced", "Expert"

  // Which interview stage should validate this?
  validationStage   String?  // "HR_SCREEN", "TECHNICAL", "PANEL", etc.
  priority          String   @default("MEDIUM") // "CRITICAL", "HIGH", "MEDIUM", "LOW"

  // Is this a must-have or nice-to-have?
  isRequired        Boolean  @default(true)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([jobId, subCompetencyId])
  @@index([jobId])
  @@index([subCompetencyId])
  @@index([validationStage])
}

// Candidate competency scores - evaluation during interviews
model CandidateCompetencyScore {
  id                String   @id @default(uuid())
  candidateId       String
  candidate         JobCandidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  subCompetencyId   String
  subCompetency     SubCompetency @relation(fields: [subCompetencyId], references: [id], onDelete: Cascade)

  // Score (raw from framework: 1-4 or 1-5 or 0-4 for AI)
  rawScore          Int      // Actual level from sheet (0-5 depending on framework)
  scoreLevelName    String   // "Basic", "Intermediate", "Proficient", "Advanced", "Expert", "Unacceptable"

  // Normalized score for cross-framework comparison (0-100)
  normalizedScore   Float    // Percentage for comparing across different level scales

  // Evidence and notes
  evidence          String?  @db.Text
  evaluatorNotes    String?  @db.Text

  // For behavioral indicator tracking (AI framework)
  checkedIndicators Json?    @db.Json // Array of indicator IDs that were checked

  // Context - which interview stage was this evaluated at?
  evaluatedAtStage  String?  // "HR_SCREEN", "TECHNICAL", "PANEL", etc.
  interviewId       String?  // Link to specific interview if applicable

  // Who evaluated
  evaluatorId       String?
  evaluatorName     String?
  evaluatorEmail    String?

  // Confidence level
  confidence        String   @default("MEDIUM") // "LOW", "MEDIUM", "HIGH"

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([candidateId, subCompetencyId, evaluatedAtStage])
  @@index([candidateId])
  @@index([subCompetencyId])
  @@index([evaluatedAtStage])
}

// Employee competency assessments - performance reviews
model EmployeeCompetencyScore {
  id                String   @id @default(uuid())
  employeeId        String
  employee          Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  subCompetencyId   String
  subCompetency     SubCompetency @relation(fields: [subCompetencyId], references: [id], onDelete: Cascade)

  // Current level (raw score)
  currentLevel      Int      // 1-5 depending on framework
  currentLevelName  String   // "Basic", "Intermediate", "Proficient", "Advanced", "Expert"
  normalizedScore   Float    // 0-100 for comparison

  // Target level for development planning
  targetLevel       Int?
  targetLevelName   String?

  // Progress tracking
  lastAssessedAt    DateTime
  nextAssessmentDue DateTime?

  // Context - which review period
  assessmentPeriod  String?  // "Q1 2025", "Annual Review 2024"
  assessorId        String?  // Manager who assessed
  assessorName      String?

  // Development notes
  strengths         String?  @db.Text
  areasForGrowth    String?  @db.Text
  developmentPlan   String?  @db.Text

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([employeeId, subCompetencyId, assessmentPeriod])
  @@index([employeeId])
  @@index([subCompetencyId])
  @@index([lastAssessedAt])
}

// Competency sync logs - track sync history
model CompetencySyncLog {
  id                String   @id @default(uuid())
  sourceId          String
  source            CompetencyFrameworkSource @relation(fields: [sourceId], references: [id], onDelete: Cascade)

  status            String   // "SUCCESS", "FAILED", "PARTIAL"
  recordsSynced     Int      @default(0)
  recordsFailed     Int      @default(0)

  errorMessage      String?  @db.Text
  syncDetails       Json?    @db.Json // Detailed log of what was synced

  triggeredBy       String?  // User ID who triggered sync
  syncDuration      Int?     // Milliseconds

  createdAt         DateTime @default(now())

  @@index([sourceId, createdAt])
  @@index([status])
  @@index([createdAt])
}

// ============================================
// RECRUITING - JOBS/POSITIONS
// ============================================

model Job {
  id                  String      @id @default(uuid())
  title               String
  department          String?     // Team name
  employmentType      String      @default("full-time") // full-time, part-time, contract, internship
  status              JobStatus   @default(DRAFT)
  priority            Int         @default(3) // 1-5, where 5 is urgent
  deadline            DateTime?
  hiresCount          Int         @default(1)

  // Salary info
  salaryMin           Int?
  salaryMax           Int?
  salaryCurrency      String?     @default("USD")
  salaryFrequency     String?     @default("annually") // annually, monthly, hourly

  // Equity info
  equityMin           Float?
  equityMax           Float?

  // Locations (stored as JSON array of strings)
  locations           Json        @default("[]")

  // Interview flow - references a snapshot of a hiring flow
  hiringFlowId        String?   // Legacy field - to be migrated
  hiringFlowSnapshotId String?
  hiringFlowSnapshot   HiringFlowSnapshot? @relation(fields: [hiringFlowSnapshotId], references: [id])

  // Job Description reference
  jobDescriptionId    String?
  jobDescription      JobDescription? @relation(fields: [jobDescriptionId], references: [id])

  // Default Offer Template for hire flow automation
  defaultOfferTemplateId String?
  defaultOfferTemplate   OfferTemplate? @relation("JobDefaultTemplate", fields: [defaultOfferTemplateId], references: [id])

  // Hiring Manager
  hiringManagerId     String?
  hiringManager       Employee?   @relation("JobHiringManager", fields: [hiringManagerId], references: [id])

  // AI settings
  autoArchiveLocation Boolean     @default(false)
  decisionSupportEnabled Boolean  @default(true)
  personalityProfilesEnabled Boolean  @default(true)
  teamProfilesEnabled Boolean  @default(true)

  // Interest Form assigned to this job
  interestFormId      String?
  interestForm        InterestFormTemplate? @relation("JobInterestForm", fields: [interestFormId], references: [id])

  // Public page settings
  slug                String?     @unique  // URL slug for public page (e.g., "senior-backend-engineer")
  isPublic            Boolean     @default(true)  // Whether to show on public careers page

  // Webhook configuration
  webhookUrl          String?     // URL to push job postings to
  webhookSecret       String?     // Optional HMAC secret for verification
  lastWebhookAt       DateTime?   // Last webhook push timestamp

  // Webflow CMS sync
  webflowItemId       String?     // Webflow collection item ID
  webflowSyncStatus   String?     // "synced", "pending", "failed", "not_synced"
  webflowSyncError    String?     // Error message if failed
  webflowLastSyncAt   DateTime?   // Last successful sync
  webflowPublishedAt  DateTime?   // When published to live site

  // Relations
  followers           JobFollower[]
  competencies        JobCompetency[] // Legacy
  competencyRequirements JobCompetencyRequirement[] // V2 competency framework
  candidates          JobCandidate[]
  interviewStages     InterviewStageTemplate[] @relation("JobInterviewStages")
  recruiterAccess     RecruiterJob[]
  interviewQuestions  InterviewQuestion[]
  emailTemplates      EmailTemplate[] @relation("JobEmailTemplates")
  assessmentTemplates JobAssessmentTemplate[]
  scorecard           Scorecard?
  actions             JobAction[]

  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt

  @@index([status])
  @@index([department])
  @@index([deadline])
  @@index([createdAt])
  @@index([interestFormId])
  @@index([hiringFlowSnapshotId])
  @@index([slug])
  @@index([isPublic])
}

model Scorecard {
  id        String   @id @default(uuid())
  jobId     String   @unique
  job       Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)

  // Mission statement - what this role needs to accomplish
  mission   String   @db.Text

  // Outcomes - measurable objectives with success criteria
  // JSON array of objects: [{ name: string, description: string, successCriteria: string[] }]
  outcomes  Json     @default("[]")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([jobId])
}

model JobFollower {
  id          String   @id @default(uuid())
  jobId       String
  job         Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  employeeId  String
  employee    Employee @relation("JobFollowers", fields: [employeeId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())

  @@unique([jobId, employeeId])
  @@index([employeeId])
}

// AI-powered automated actions linked to jobs
model JobAction {
  id          String        @id @default(uuid())
  jobId       String
  job         Job           @relation(fields: [jobId], references: [id], onDelete: Cascade)
  actionId    String
  action      AICustomTool  @relation(fields: [actionId], references: [id], onDelete: Cascade)

  // Configuration for this specific action on this job
  isEnabled   Boolean       @default(true)
  config      Json?         // Action-specific configuration (e.g., thresholds, conditions)

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@unique([jobId, actionId])
  @@index([jobId])
  @@index([actionId])
}

model JobCompetency {
  id           String     @id @default(uuid())
  jobId        String
  job          Job        @relation(fields: [jobId], references: [id], onDelete: Cascade)
  competencyId String
  competency   Competency @relation(fields: [competencyId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now())

  @@unique([jobId, competencyId])
  @@index([competencyId])
}

// Job Candidates - tracking applicants through the hiring pipeline
model JobCandidate {
  id          String            @id @default(uuid())
  jobId       String
  job         Job               @relation(fields: [jobId], references: [id], onDelete: Cascade)

  // Basic candidate info
  name        String
  email       String
  phone       String?
  resumeUrl   String?
  linkedinUrl String?
  otherContactInfo String?
  avatarUrl   String?

  // Professional info
  currentRole    String?        // e.g., "Senior Backend Engineer (Tech Lead)"
  currentCompany String?        // e.g., "Paystack"
  yearsOfExperience Float?      // e.g., 6.5
  location       String?        // e.g., "Lagos, Nigeria"

  // Structured resume data (AI-extracted or manual)
  workExperience Json?          // Array of { title, company, startDate, endDate, isCurrent, description, highlights, skills }
  education      Json?          // Array of { degree, field, institution, startYear, endYear, honors }
  skills         Json?          // { languages: [], databases: [], infrastructure: [], frameworks: [] }
  resumeSummary  String?        @db.Text // AI-generated summary

  // Pipeline tracking
  stage       JobCandidateStage @default(APPLIED)
  customStageName String?       // For legacy candidates when flow changes - stores display name
  score       Int?              // Overall AI score 0-100

  // Score breakdown (AI-generated)
  experienceMatchScore Int?     // 0-100
  skillsMatchScore     Int?     // 0-100
  domainFitScore       Int?     // 0-100
  educationScore       Int?     // 0-100
  scoreExplanation     String?  @db.Text

  // Interest form responses
  whyCuracel       String?      @db.Text
  salaryExpMin     Int?
  salaryExpMax     Int?
  salaryExpCurrency String?     @default("USD")
  noticePeriod     String?      // e.g., "4 weeks"
  mbtiType         String?      // e.g., "INTJ"

  // PRESS Values alignment scores (AI-assessed from interviews)
  pressValuesScores Json?       // { passionate: 88, relentless: 85, empowered: 82, senseOfUrgency: 76, seeingPossibilities: 80 }
  pressValuesAvg    Int?        // Average of PRESS scores

  // Legacy competency scores from assessments (V1 - deprecated)
  legacyCompetencyScores  Json?  @map("competencyScores")  // { systemDesign: 90, technicalLeadership: 85, problemSolving: 88, communication: 82, domainKnowledge: 65 }

  // Personality/Team fit analysis
  personalityProfile Json?      // { openness: 85, conscientiousness: 90, extraversion: 45, agreeableness: 70, neuroticism: 25 }
  teamFitAnalysis    Json?      // { strengths: [], considerations: [] }

  // Must validate / concerns
  mustValidate   Json?          // Array of strings to validate in interviews
  redFlags       Json?          // Array of { title, description }

  // Suggested interview questions
  suggestedQuestions Json?      // Array of strings

  // AI Recommendation
  recommendation           String?    // "HIRE", "HOLD", "NO_HIRE"
  recommendationConfidence Int?       // 0-100
  recommendationSummary    String?    @db.Text
  recommendationStrengths  Json?      // Array of strengths
  recommendationRisks      Json?      // Array of { risk, mitigation }

  // Human decision
  decisionStatus String?       // "PENDING", "HIRE", "HOLD", "NO_HIRE"
  decisionNotes  String?       @db.Text
  decisionBy     String?       // Employee/User ID
  decisionAt     DateTime?

  // Source tracking (enhanced)
  source          CandidateSource   @default(INBOUND)
  inboundChannel  InboundChannel?   // Sub-source for INBOUND (YC, PeopleOS, etc.)
  outboundChannel OutboundChannel?  // Sub-source for OUTBOUND (LinkedIn, Job boards, etc.)

  // Who added/sourced this candidate
  addedById       String?           // Employee ID who sourced/added (for OUTBOUND/EXCELLER)
  addedBy         Employee?         @relation("CandidatesAddedBy", fields: [addedById], references: [id])
  referredBy      String?           // Legacy field - Employee ID if referral

  // Recruiter link (for RECRUITER source)
  recruiterCandidate RecruiterCandidate?

  // Application content
  bio             String?           @db.Text  // Brief bio
  coverLetter     String?           @db.Text  // Why they are applying

  // Notes (internal)
  notes       String?           @db.Text

  // Candidate documents (resumes, cover letters, portfolios, certificates)
  documents   Json?             // Array of { id, name, type, url, uploadedAt }
                                // Types: 'resume', 'cover_letter', 'portfolio', 'certificate', 'other'

  // Processing status for AI analysis
  processingStatus String?      // "pending", "processing", "completed", "failed"
  processedAt      DateTime?

  // Timestamps
  appliedAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  // Interest form responses
  interestFormResponses InterestFormResponse[]

  // Interview stages tracking
  interviews  CandidateInterview[]

  // Assessment tracking
  assessments CandidateAssessment[]

  // Competency scores (V2 framework)
  competencyScores CandidateCompetencyScore[]

  // Email threads with candidate
  emailThreads CandidateEmailThread[]

  // Complete email sync tracking
  emailSyncs   CandidateEmailSync[]

  // AI analysis versions
  aiAnalyses   CandidateAIAnalysis[]

  // Queued stage transition emails
  queuedEmails QueuedStageEmail[]

  // Link to employee record if hired
  employee     Employee?        @relation("EmployeeCandidate")

  @@unique([jobId, email])
  @@index([jobId, stage])
  @@index([email])
  @@index([score])
}

// Track individual interview stages/rounds
model CandidateInterview {
  id           String       @id @default(uuid())
  candidateId  String
  candidate    JobCandidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  stage        String       // "HR_SCREEN", "TECHNICAL", "PANEL"
  stageName    String?      // Display name e.g., "General Questions", "Panel Interview"
  interviewers Json?        // Array of { employeeId, name, email }
  scheduledAt  DateTime?
  completedAt  DateTime?
  duration     Int?         // Duration in minutes

  // Aggregated scores from evaluations
  score        Int?         // 0-100 (calculated average)
  feedback     String?      @db.Text
  scorecard    Json?        // Legacy: { criteria: [{ name, score, notes }] }

  // Link to interview stage template for rubric
  stageTemplateId String?

  // Link to interview type
  interviewTypeId String?
  interviewType   InterviewType? @relation(fields: [interviewTypeId], references: [id])

  // Aggregated overall score (0-100)
  overallScore    Int?

  // Individual evaluator scorecards
  evaluations  InterviewEvaluation[]

  // Public interview links for interviewers
  interviewerTokens InterviewerToken[]

  // Questions used in this interview
  questionUsages InterviewQuestionUsage[]

  // Pre-assigned questions (during scheduling)
  assignedQuestions InterviewAssignedQuestion[]

  // Fireflies integration
  firefliesMeetingId   String?   // Fireflies meeting ID
  firefliesTranscript  String?   @db.Text // Full transcript
  firefliesSummary     String?   @db.Text // AI-generated summary
  firefliesActionItems Json?     // Array of action items
  firefliesHighlights  Json?     // Array of { timestamp, text }
  transcriptUrl        String?   // Link to Fireflies transcript
  recordingUrl         String?   // Link to recording
  meetingLink          String?   // Video meeting link (Zoom/Google Meet)

  status       String       @default("SCHEDULED") // SCHEDULED, IN_PROGRESS, COMPLETED, CANCELLED, NO_SHOW

  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@index([candidateId, stage])
  @@index([scheduledAt])
  @@index([stageTemplateId])
  @@index([interviewTypeId])
}

// Public interview tokens for interviewers
model InterviewerToken {
  id           String             @id @default(uuid())
  token        String             @unique @default(uuid())
  interviewId  String
  interview    CandidateInterview @relation(fields: [interviewId], references: [id], onDelete: Cascade)

  // Token type: INTERVIEWER (can score questions) or PEOPLE_TEAM (view-only)
  tokenType    String   @default("INTERVIEWER")

  // Interviewer info
  interviewerId    String?  // User ID if internal
  interviewerName  String
  interviewerEmail String
  interviewerRole  String?

  // Token status
  expiresAt    DateTime
  accessedAt   DateTime?  // First access
  lastAccessAt DateTime?  // Most recent access
  isRevoked    Boolean    @default(false)

  // Evaluation status
  evaluationStatus String   @default("PENDING") // PENDING, IN_PROGRESS, SUBMITTED
  submittedAt      DateTime?

  // Evaluation data (for external interviewers submitting feedback)
  overallRating    Int?              // 1-5 scale
  recommendation   String?           // 'STRONG_YES', 'YES', 'MAYBE', 'NO', 'STRONG_NO'
  evaluationNotes  String?  @db.Text // General feedback/notes from interviewer

  // Custom questions added by this interviewer
  customQuestions Json?    // Array of { question, answer, score }

  // Question responses (scores and notes for assigned interview questions)
  questionResponses Json?  // Record<questionId, { score: 1-5, notes: string }>

  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@index([token])
  @@index([interviewId])
  @@index([interviewerEmail])
}

enum JobCandidateStage {
  APPLIED
  SHORTLISTED
  HR_SCREEN      // People Chat
  TEAM_CHAT      // Team Chat (NEW)
  ADVISOR_CHAT   // Advisor Chat (NEW)
  TECHNICAL      // Coding Assessment/Test
  PANEL
  TRIAL
  CEO_CHAT
  OFFER
  HIRED
  REJECTED
  WITHDRAWN
  ARCHIVED       // Archived/past candidates for talent pool
}

enum JobStatus {
  DRAFT
  ACTIVE
  PAUSED
  HIRED
}

// ============================================
// RECRUITING - CANDIDATE SOURCE TRACKING
// ============================================

enum CandidateSource {
  INBOUND    // Applied via public job page
  OUTBOUND   // Sourced by team member from external platforms
  RECRUITER  // Added by external recruiter
  EXCELLER   // Added by internal Curacel employee
}

enum InboundChannel {
  YC           // Y Combinator Work at a Startup
  PEOPLEOS     // PeopleOS careers page
  COMPANY_SITE // Direct company website
  OTHER        // Other inbound channel
}

enum OutboundChannel {
  LINKEDIN    // LinkedIn sourcing
  JOB_BOARDS  // Indeed, Glassdoor, etc.
  GITHUB      // GitHub profiles
  TWITTER     // Twitter/X
  OTHER       // Other outbound channel
}

// ============================================
// RECRUITING - EXTERNAL RECRUITERS
// ============================================

model Recruiter {
  id               String   @id @default(uuid())
  name             String
  email            String   @unique
  organizationName String?
  isActive         Boolean  @default(true)

  jobAccess        RecruiterJob[]
  candidates       RecruiterCandidate[]

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([email])
  @@index([isActive])
}

model RecruiterJob {
  id          String    @id @default(uuid())
  recruiterId String
  recruiter   Recruiter @relation(fields: [recruiterId], references: [id], onDelete: Cascade)
  jobId       String
  job         Job       @relation(fields: [jobId], references: [id], onDelete: Cascade)

  accessToken String    @unique @default(uuid())
  lastAccessedAt DateTime?

  createdAt   DateTime  @default(now())

  @@unique([recruiterId, jobId])
  @@index([accessToken])
  @@index([jobId])
}

model RecruiterCandidate {
  id          String       @id @default(uuid())
  recruiterId String
  recruiter   Recruiter    @relation(fields: [recruiterId], references: [id], onDelete: Cascade)
  candidateId String       @unique
  candidate   JobCandidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  createdAt   DateTime     @default(now())

  @@index([recruiterId])
}

// ============================================
// HIRING - SETTINGS
// ============================================

model HiringSettings {
  id                 String   @id @default(uuid())
  organizationId     String   @unique

  // Global webhook
  globalWebhookUrl   String?
  globalWebhookSecret String?

  // Branding for public careers page
  companyLogoUrl     String?
  companyDescription String?  @db.Text
  socialLinks        Json?    // { linkedin, twitter, website }

  // Custom channels (JSON arrays)
  customInboundChannels  Json? // ["Custom Channel 1", ...]
  customOutboundChannels Json?

  // Candidate scoring weights
  candidateScoreWeights Json? // [{ id, label, description, weight, enabled }]
  jobScoreDisplay     String  @default("average")
  decisionSupportEnabled Boolean @default(true)
  personalityProfilesEnabled Boolean @default(true)
  teamProfilesEnabled Boolean @default(true)

  // AuntyPelz automated actions
  autoArchiveUnqualified Boolean @default(false) // Auto-archive applicants that don't meet requirements
  autoArchiveLocationMismatch Boolean @default(false) // Auto-archive applicants that don't meet location requirements

  // Stage movement restrictions
  allowBackwardStageMovement Boolean @default(false) // Allow moving candidates to earlier stages
  probationLengthFullTimeMonths Int @default(3)
  probationLengthPartTimeMonths Int @default(3)
  probationLengthContractorMonths Int @default(3)
  probationLengthInternMonths Int @default(3)

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

// ============================================
// RECRUITING - INTEREST FORMS
// ============================================

// Interest Form Template - can be assigned to jobs
model InterestFormTemplate {
  id          String   @id @default(uuid())
  name        String   // e.g., "Senior Enterprise Account Executive Interest Form"
  description String?
  isDefault   Boolean  @default(false) // Default form for new jobs
  isActive    Boolean  @default(true)

  questions   InterestFormQuestion[]
  jobs        Job[]    @relation("JobInterestForm")
  responses   InterestFormResponse[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive])
  @@index([isDefault])
}

model InterestFormQuestion {
  id           String               @id @default(uuid())
  templateId   String
  template     InterestFormTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  question     String               // The question text
  description  String?              // Optional help text
  type         String               // "text", "textarea", "select", "multiselect", "checkbox", "scale", "email", "number"
  required     Boolean              @default(true)
  sortOrder    Int                  @default(0)

  // For select/multiselect/checkbox
  options      Json?                // Array of { value, label }

  // For scale type
  scaleMin     Int?                 @default(1)
  scaleMax     Int?                 @default(5)
  scaleMinLabel String?             // e.g., "Novice"
  scaleMaxLabel String?             // e.g., "Expert"

  // Field mapping for auto-population
  fieldMapping String?              // e.g., "email", "name", "mbtiType", "salaryExpMin" - maps to JobCandidate fields

  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt

  @@index([templateId, sortOrder])
}

// Store candidate responses to interest forms
model InterestFormResponse {
  id           String               @id @default(uuid())
  templateId   String
  template     InterestFormTemplate @relation(fields: [templateId], references: [id])
  candidateId  String?
  candidate    JobCandidate?        @relation(fields: [candidateId], references: [id], onDelete: SetNull)

  // Denormalized candidate info in case candidate is deleted
  candidateEmail String
  candidateName  String

  // All responses stored as JSON
  responses    Json                 // { questionId: answer, ... }

  // Public submission token
  submissionToken String?           @unique

  // AI analysis of responses
  aiAnalysis      Json?             // { summary, keyInsights, concerns, scores }
  aiAnalyzedAt    DateTime?

  submittedAt  DateTime             @default(now())

  @@index([templateId])
  @@index([candidateId])
  @@index([candidateEmail])
}

// ============================================
// RECRUITING - INTERVIEW TYPES & RUBRICS
// ============================================

// Interview Type - defines distinct interview types with their rubric, interviewers, and questions
model InterviewType {
  id                 String   @id @default(uuid())
  name               String   // "People Chat", "Team Chat", "Technical", etc.
  slug               String   @unique
  description        String?
  defaultDuration    Int      @default(60) // minutes
  isFeatured         Boolean  @default(true)

  // Link to rubric template
  rubricTemplateId   String?
  rubricTemplate     InterviewStageTemplate? @relation(fields: [rubricTemplateId], references: [id])

  // Interviewer constraints - which roles can conduct this type
  allowedRoles       String[] // ["HR", "HIRING_MANAGER", "ENGINEER", "EXECUTIVE", "ANY"]

  // Question categories for this type (from Question Bank)
  questionCategories String[] // ["situational", "behavioral", "technical", "culture", "motivational"]

  // Display order
  sortOrder          Int      @default(0)
  isActive           Boolean  @default(true)

  // Interviews of this type
  interviews         CandidateInterview[]

  // Questions specific to this interview type
  questions          InterviewQuestion[]

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([slug])
  @@index([isActive])
}

// Interview Stage Template - defines the stages and their rubrics
model InterviewStageTemplate {
  id          String   @id @default(uuid())
  name        String   // e.g., "General Questions", "Panel Interview", "Technical Assessment"
  description String?
  stage       String   // Maps to JobCandidateStage: "HR_SCREEN", "TECHNICAL", "PANEL"
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)

  // Can be job-specific or general
  jobId       String?
  job         Job?     @relation("JobInterviewStages", fields: [jobId], references: [id], onDelete: Cascade)

  criteria       InterviewStageCriteria[]
  evaluations    InterviewEvaluation[]
  interviewTypes InterviewType[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([stage])
  @@index([jobId])
  @@index([isActive])
}

// Criteria for each interview stage
model InterviewStageCriteria {
  id          String                 @id @default(uuid())
  stageId     String
  stage       InterviewStageTemplate @relation(fields: [stageId], references: [id], onDelete: Cascade)

  name        String                 // e.g., "Problem Solving", "Communication"
  description String?                // What to look for
  weight      Int                    @default(1) // 1-5 for importance
  sortOrder   Int                    @default(0)

  // Scoring scale definitions (stored as JSON for flexibility)
  // e.g., { 1: "Poor - No evidence", 2: "Below Average", 3: "Average", 4: "Above Average", 5: "Excellent - Strong evidence" }
  scoreScale  Json?

  createdAt   DateTime               @default(now())
  updatedAt   DateTime               @updatedAt

  scores      InterviewCriteriaScore[]

  @@index([stageId, sortOrder])
}

// Individual evaluator's scorecard for a candidate interview
model InterviewEvaluation {
  id           String                 @id @default(uuid())
  interviewId  String
  interview    CandidateInterview     @relation(fields: [interviewId], references: [id], onDelete: Cascade)
  stageTemplateId String?             // Optional - may not have rubric configured
  stageTemplate InterviewStageTemplate? @relation(fields: [stageTemplateId], references: [id])

  // Evaluator info
  evaluatorId   String?               // Employee ID (null for external interviewers)
  evaluatorName String
  evaluatorEmail String?

  // Overall assessment
  overallScore  Int?                  // 1-5 or calculated average
  overallNotes  String?               @db.Text
  recommendation String?              // "STRONG_HIRE", "HIRE", "HOLD", "NO_HIRE", "STRONG_NO_HIRE"

  // Individual criteria scores
  criteriaScores InterviewCriteriaScore[]

  submittedAt  DateTime?
  createdAt    DateTime               @default(now())
  updatedAt    DateTime               @updatedAt

  @@unique([interviewId, evaluatorEmail])  // Use email for uniqueness
  @@index([interviewId])
  @@index([evaluatorId])
  @@index([stageTemplateId])
}

// Individual score for each criteria
model InterviewCriteriaScore {
  id           String                 @id @default(uuid())
  evaluationId String
  evaluation   InterviewEvaluation    @relation(fields: [evaluationId], references: [id], onDelete: Cascade)
  criteriaId   String
  criteria     InterviewStageCriteria @relation(fields: [criteriaId], references: [id], onDelete: Cascade)

  score        Int                    // 1-5
  notes        String?                @db.Text

  createdAt    DateTime               @default(now())
  updatedAt    DateTime               @updatedAt

  @@unique([evaluationId, criteriaId])
  @@index([criteriaId])
}

// ============================================
// RECRUITING - ASSESSMENTS
// ============================================

enum AssessmentType {
  COMPETENCY_TEST
  CODING_TEST
  PERSONALITY_TEST
  WORK_TRIAL
  CUSTOM
}

enum AssessmentStatus {
  NOT_STARTED
  INVITED
  IN_PROGRESS
  COMPLETED
  EXPIRED
  CANCELLED
}

enum AssessmentInputMethod {
  CANDIDATE    // Candidate submits directly (file, text, or URL)
  ADMIN        // Admin enters the result manually
  WEBHOOK      // External platform sends via webhook/API
}

enum CandidateSubmissionType {
  FILE         // File upload (PDF, image, etc.)
  TEXT         // Text response
  URL          // URL link to their work
}

// ============================================
// EMAIL & COMMUNICATION ENUMS
// ============================================

enum EmailDirection {
  OUTBOUND  // Sent by recruiter to candidate
  INBOUND   // Received from candidate
}

enum EmailStatus {
  DRAFT
  QUEUED
  SENT
  DELIVERED
  OPENED
  CLICKED
  BOUNCED
  FAILED
}

enum EmailCategory {
  APPLICATION              // Application/initial contact
  INTERVIEW_SCHEDULING     // Interview scheduling
  INTERVIEW_FOLLOWUP       // Interview follow-up
  ASSESSMENT               // Assessment/test
  OFFER                    // Offer
  ONBOARDING               // Onboarding
  GENERAL_FOLLOWUP         // General follow-up
  OTHER                    // Other
}

enum AnalysisType {
  APPLICATION_REVIEW     // Initial application analysis
  STAGE_SUMMARY          // After completing a stage
  INTERVIEW_ANALYSIS     // Post-interview insights
  ASSESSMENT_REVIEW      // After assessment completion
  COMPREHENSIVE          // Full candidate analysis
  SENTIMENT_CHANGE       // When AI detects significant changes
}

// Assessment Template - configurable per organization/team
model AssessmentTemplate {
  id              String           @id @default(uuid())
  organizationId  String
  teamId          String?          // NULL = global, set = team-specific

  name            String           // e.g., "Backend Coding Challenge"
  description     String?
  type            AssessmentType

  // How results are submitted
  inputMethod             AssessmentInputMethod @default(CANDIDATE)
  candidateSubmissionTypes CandidateSubmissionType[] // What candidate can submit: FILE, TEXT, URL

  // Configuration
  durationMinutes Int?
  passingScore    Int?
  instructions    String?          @db.Text

  // External platform (Kandi.io, etc.)
  externalUrl     String?
  externalPlatform String?         // "kandi", "hackerrank", etc.

  // Email template for sending
  emailSubject    String?
  emailBody       String?          @db.Text

  // Webhook for receiving results
  webhookUrl      String?
  webhookSecret   String?

  // Scoring rubric (JSON)
  scoringRubric   Json?            // { criteria: [{name, weight, maxScore}] }

  // AI Generation
  aiGenerated     Boolean          @default(false)
  aiPrompt        String?          @db.Text
  aiModel         String?
  questions       Json?            // Array of { id, text, type, options?, maxScore }

  // Integration Config (for multi-platform support)
  integrationConfig Json?          // Platform-specific config (API keys, etc.)

  // Scoring Config
  scoringDimensions Json?          // { technical: 40, behavioral: 30, aptitude: 30 }
  benchmarkData     Json?          // Role-based benchmark scores

  isFeatured      Boolean          @default(true)
  isActive        Boolean          @default(true)
  sortOrder       Int              @default(0)

  candidateAssessments CandidateAssessment[]
  workTrialTemplate    WorkTrialTemplate?
  jobAssessments       JobAssessmentTemplate[]

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([organizationId, type])
  @@index([teamId])
  @@index([isActive])
}

// Candidate Assessment - results per candidate
model CandidateAssessment {
  id              String           @id @default(uuid())
  candidateId     String
  candidate       JobCandidate     @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  templateId      String
  template        AssessmentTemplate @relation(fields: [templateId], references: [id])

  status          AssessmentStatus @default(NOT_STARTED)

  // Scores (supports multiple score types)
  overallScore    Int?             // 0-100
  scores          Json?            // { correctness: 7, codeQuality: 7, alignment: 7 }
  percentile      Int?

  // Results
  resultUrl       String?          // Link to external report
  resultData      Json?            // Structured result (webhook payload, etc.)
  recommendation  String?          // HIRE, HOLD, NO_HIRE
  summary         String?          @db.Text
  strengths       Json?            // Array of strings
  risks           Json?            // Array of strings
  questionsForCandidate Json?      // Array of interview questions

  // Candidate responses (for AI-graded assessments)
  responses       Json?            // Array of { questionId, response, submittedAt }

  // AI Analysis
  aiAnalysis      Json?            // Structured AI analysis
  aiRecommendation String?         // HIRE, HOLD, NO_HIRE with reasoning
  aiConfidence    Float?           // 0-1 confidence score

  // Detailed Scoring (by dimension)
  dimensionScores Json?            // { technical: 85, behavioral: 72, aptitude: 90 }
  benchmarkComparison Json?        // { roleAvg: 75, percentile: 85 }
  teamFitScore    Float?           // 0-100

  // Predictive Analytics
  predictedPerformance Float?      // AI predicted job performance (0-100)
  predictedTenure Int?             // Predicted months at company

  // Submission tracking
  submissionMethod  AssessmentInputMethod?  // How result was submitted
  submittedById     String?                 // Admin ID if submitted by admin
  submittedAt       DateTime?               // When submission was received

  // Candidate submissions (when inputMethod is CANDIDATE)
  submissionText    String?          @db.Text  // Text submission
  submissionUrl     String?                    // URL submission
  submissionFiles   Json?                      // Array of { url, name, type, size }

  // File uploads (legacy - keep for backwards compat)
  fileUrl         String?
  fileName        String?
  extractedData   Json?            // AI-extracted data from file

  // Work Trial specific
  dashboardUrl    String?          // Google Sheet URL
  dashboardData   Json?            // Synced data from sheet
  dailyUpdates    Json?            // Array of daily standup entries
  completionPercent Int?           // 0-100
  qualityScore    Int?             // 0-100

  // Timing
  inviteSentAt    DateTime?
  startedAt       DateTime?
  completedAt     DateTime?
  expiresAt       DateTime?
  lastSyncedAt    DateTime?        // For dashboard sync

  // Invite
  inviteToken     String?          @unique

  // External Platform
  externalId      String?          // ID from external platform (Kandi, etc.)
  externalUrl     String?          // URL to external assessment

  notes           String?          @db.Text
  evaluatedBy     String?          // Employee ID who reviewed
  evaluatedAt     DateTime?

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@unique([candidateId, templateId])
  @@index([candidateId])
  @@index([templateId])
  @@index([status])
}

// Work Trial Template - extended config for work trials
model WorkTrialTemplate {
  id                   String             @id @default(uuid())
  assessmentTemplateId String             @unique
  assessmentTemplate   AssessmentTemplate @relation(fields: [assessmentTemplateId], references: [id], onDelete: Cascade)

  // Template structure
  tasks                Json               // Array of { name, description, deliverables }
  durationDays         Int                @default(5)

  // People
  defaultBuddyId       String?            // Default buddy employee

  // Check-ins
  checkInSchedule      Json?              // { day1: true, day3: true, day5: true }

  // Dashboard template
  dashboardTemplateUrl String?            // Google Sheet template to clone
  dashboardMetrics     Json?              // { columns: ["Task", "Status", "Notes", ...] }

  // Evaluation rubric
  evaluationCriteria   Json?              // Array of { name, weight, description }

  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
}

// Job-Assessment Template linking - configure assessments per job
model JobAssessmentTemplate {
  id           String             @id @default(uuid())
  jobId        String
  job          Job                @relation(fields: [jobId], references: [id], onDelete: Cascade)
  templateId   String
  template     AssessmentTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  // Auto-trigger configuration
  triggerStage String?            // Auto-send at this stage (e.g., "TECHNICAL")
  isRequired   Boolean            @default(false)
  sortOrder    Int                @default(0)

  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  @@unique([jobId, templateId])
  @@index([jobId])
  @@index([templateId])
}

// ============================================
// RECRUITING - QUESTION BANK
// ============================================

// Interview Question - reusable questions for interviews
model InterviewQuestion {
  id              String   @id @default(uuid())
  text            String   @db.Text
  followUp        String?  @db.Text  // Suggested follow-up question

  // Categorization
  category        String   // "situational", "behavioral", "technical", "motivational", "culture"
  tags            String[] // ["Problem Solving", "Leadership", "Communication", etc.]

  // Context - can be global or specific
  jobId           String?  // Job-specific question (null = global)
  job             Job?     @relation(fields: [jobId], references: [id], onDelete: SetNull)
  interviewTypeId String?  // Type-specific (null = all types)
  interviewType   InterviewType? @relation(fields: [interviewTypeId], references: [id], onDelete: SetNull)

  // Usage tracking
  timesUsed       Int      @default(0)
  avgRating       Float?   // How helpful was this question? (1-5)

  // Metadata
  createdById     String?
  createdBy       Employee? @relation(fields: [createdById], references: [id], onDelete: SetNull)
  isActive        Boolean  @default(true)
  isFavorite      Boolean  @default(false)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  usages          InterviewQuestionUsage[]
  assignedTo      InterviewAssignedQuestion[]

  @@index([category])
  @@index([jobId])
  @@index([interviewTypeId])
  @@index([isActive])
}

// Track which questions were used in interviews
model InterviewQuestionUsage {
  id              String   @id @default(uuid())
  questionId      String
  question        InterviewQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  interviewId     String
  interview       CandidateInterview @relation(fields: [interviewId], references: [id], onDelete: Cascade)

  // Who asked this question
  askedById       String?
  askedByName     String?

  // Effectiveness rating
  rating          Int?     // 1-5 how helpful was this question
  notes           String?  @db.Text

  wasAsked        Boolean  @default(true)  // Track if actually asked vs just suggested

  createdAt       DateTime @default(now())

  @@unique([questionId, interviewId])
  @@index([interviewId])
  @@index([questionId])
}

// Questions assigned to an interview during scheduling (before the interview)
model InterviewAssignedQuestion {
  id              String   @id @default(uuid())
  interviewId     String
  interview       CandidateInterview @relation(fields: [interviewId], references: [id], onDelete: Cascade)

  // Either a question from the bank or a custom question
  questionId      String?  // Null if custom question
  question        InterviewQuestion? @relation(fields: [questionId], references: [id], onDelete: SetNull)
  customText      String?  @db.Text // For inline custom questions not in bank
  category        String?  // Category for custom questions

  // Metadata
  isRequired      Boolean  @default(false)  // Must be asked
  wasAsked        Boolean  @default(false)  // Tracked after interview
  rating          Int?     // 1-5 effectiveness (post-interview)
  notes           String?  @db.Text
  sortOrder       Int      @default(0)

  // Track if custom question should be saved to bank
  saveToBank      Boolean  @default(false)

  // Interviewer assignment (for multi-interviewer interviews)
  assignedToInterviewerId   String?  // ID of the assigned interviewer
  assignedToInterviewerName String?  // Name for display (since interviewers are stored as JSON)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([interviewId])
  @@index([questionId])
  @@index([assignedToInterviewerId])
}

// ============================================
// EMAIL & COMMUNICATION SYSTEM
// ============================================

// Email Thread - groups all emails for a candidate
model CandidateEmailThread {
  id              String   @id @default(uuid())
  candidateId     String
  candidate       JobCandidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  // Gmail thread tracking
  gmailThreadId   String?  @unique  // Gmail thread ID for threading
  subject         String   // Thread subject line

  // Participants
  recruiterEmail  String   // Sending as this email
  recruiterId     String?  // Employee ID of recruiter
  ccEmails        String[] @default([])

  // Status
  lastMessageAt   DateTime @default(now())
  messageCount    Int      @default(0)
  unreadCount     Int      @default(0)

  messages        CandidateEmail[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([candidateId])
  @@index([recruiterId])
  @@index([lastMessageAt])
}

// Individual Email Message
model CandidateEmail {
  id              String   @id @default(uuid())
  threadId        String
  thread          CandidateEmailThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  // Gmail message tracking
  gmailMessageId  String?  @unique
  messageIdHeader String?  // RFC 5322 Message-ID for In-Reply-To
  inReplyTo       String?  // Parent message ID header
  references      String?  @db.Text // Full References header chain

  // Email content
  direction       EmailDirection
  fromEmail       String
  fromName        String?
  toEmails        String[]
  ccEmails        String[]
  subject         String
  htmlBody        String   @db.Text
  textBody        String?  @db.Text

  // Attachments
  attachments     Json?    // Array of { id, name, mimeType, size, gmailAttachmentId, url }

  // Status and tracking
  status          EmailStatus @default(DRAFT)
  sentAt          DateTime?
  deliveredAt     DateTime?

  // Tracking events
  openedAt        DateTime?
  openCount       Int      @default(0)
  clickedAt       DateTime?
  clickCount      Int      @default(0)
  totalReadTime   Int      @default(0)  // Seconds estimated

  // Error handling
  errorMessage    String?
  retryCount      Int      @default(0)

  // Template reference
  templateId      String?
  template        EmailTemplate? @relation(fields: [templateId], references: [id])

  // Reminders for this email
  reminders       EmailReminder[]

  // AI Categorization
  category          EmailCategory?
  categoryConfidence Float?         // 0.0 to 1.0
  categorizedAt     DateTime?
  categorizedBy     String?         // 'AI' or userId

  // Hiring period tracking
  isInHiringPeriod  Boolean         @default(false)

  // Enhanced metadata
  participants      Json?           // Array of all email addresses involved

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([threadId])
  @@index([status])
  @@index([sentAt])
  @@index([category])
  @@index([isInHiringPeriod])
}

// Email Template with hierarchical overrides
model EmailTemplate {
  id              String   @id @default(uuid())

  // Template identification
  name            String
  slug            String   // e.g., "stage-advance", "rejection", "assessment-invite"
  description     String?
  category        String   // "stage_notification", "rejection", "assessment", "offer", "reminder", "general"

  // Hierarchical: jobId null = global default, jobId set = per-job override
  jobId           String?
  job             Job?     @relation("JobEmailTemplates", fields: [jobId], references: [id], onDelete: Cascade)

  // Which stage this template applies to (optional)
  stage           String?  // e.g., "HR_SCREEN", "TECHNICAL", etc.

  // Content
  subject         String
  htmlBody        String   @db.Text
  textBody        String?  @db.Text

  // AI enhancement settings
  aiEnhancementEnabled Boolean @default(false)
  aiEnhancementPrompt  String? @db.Text  // Custom AI instructions

  // Metadata
  isActive        Boolean  @default(true)
  isDefault       Boolean  @default(false)  // Default for category/stage
  usageCount      Int      @default(0)

  emails          CandidateEmail[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([slug, jobId])  // Slug unique per job (null = global)
  @@index([category])
  @@index([stage])
  @@index([isActive])
}

// Email Reminder Configuration
model EmailReminder {
  id              String   @id @default(uuid())
  emailId         String
  email           CandidateEmail @relation(fields: [emailId], references: [id], onDelete: Cascade)

  // Reminder config
  reminderType    String   // "candidate_no_response", "recruiter_followup"
  triggerAfterHours Int    @default(72)  // Hours after email sent

  // Status
  scheduledFor    DateTime
  sentAt          DateTime?
  escalatedAt     DateTime?  // When recruiter was alerted

  // Escalation
  escalateAfterHours Int?   // Hours to wait before alerting recruiter
  escalatedToId   String?   // Employee ID notified

  isCancelled     Boolean  @default(false)

  createdAt       DateTime @default(now())

  @@index([scheduledFor])
  @@index([emailId])
  @@index([isCancelled])
}

// Email Tracking Events (for detailed analytics)
model EmailTrackingEvent {
  id              String   @id @default(uuid())
  emailId         String

  eventType       String   // "open", "click", "unsubscribe"
  eventData       Json?    // { linkUrl, userAgent, ipAddress, etc. }

  occurredAt      DateTime @default(now())

  @@index([emailId])
  @@index([eventType])
  @@index([occurredAt])
}

// Complete Email Sync Tracking for Candidates
model CandidateEmailSync {
  id            String   @id @default(uuid())
  candidateId   String
  candidate     JobCandidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  // Sync metadata
  lastSyncAt    DateTime @default(now())
  emailsFound   Int      @default(0)
  emailsNew     Int      @default(0)
  emailsFailed  Int      @default(0)
  syncStatus    String   // 'IN_PROGRESS', 'COMPLETED', 'FAILED'
  errorMessage  String?  @db.Text

  // Date range synced
  fromDate      DateTime
  toDate        DateTime

  // AI categorization status
  categorizationStatus String @default("PENDING") // 'PENDING', 'IN_PROGRESS', 'COMPLETED', 'FAILED'
  categorizedCount     Int    @default(0)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([candidateId])
  @@index([syncStatus])
}

// ============================================
// BLUEAI VERSIONED ANALYSIS
// ============================================

// Versioned AI Analysis for candidates
model CandidateAIAnalysis {
  id              String   @id @default(uuid())
  candidateId     String
  candidate       JobCandidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  // Version tracking
  version         Int      @default(1)
  analysisType    AnalysisType

  // Context: what triggered this analysis
  triggerStage    String?  // Stage when analysis was generated
  triggerEvent    String?  // "stage_complete", "interview_complete", "assessment_complete", "manual"
  interviewId     String?  // If triggered by specific interview
  assessmentId    String?  // If triggered by specific assessment

  // Analysis content
  summary         String   @db.Text    // Main summary paragraph
  strengths       Json     // Array of strings
  concerns        Json     // Array of { title, description, severity }
  recommendations Json     // Array of strings

  // Scores at this point in time
  overallScore    Int?     // 0-100
  scoreBreakdown  Json?    // { experience: 85, skills: 82, culture: 78, ... }

  // Sentiment tracking
  sentimentScore  Int?     // -100 to 100 (negative to positive)
  sentimentChange Int?     // Change from previous version
  sentimentReason String?  // Why sentiment changed

  // Tab-specific summaries
  tabSummaries    Json?    // { overview: "...", application: "...", interviews: "...", values: "..." }

  // PRESS Values assessment at this stage
  pressValues     Json?    // { passionate: 4.2, relentless: 3.8, ... }

  // Hiring recommendation
  recommendation  String?  // "STRONG_HIRE", "HIRE", "HOLD", "NO_HIRE"
  confidence      Int?     // 0-100

  // Must-validate points and suggested questions
  mustValidatePoints   Json?  // Array of points to validate in next stage
  nextStageQuestions   Json?  // Array of suggested questions for next stage

  // AI model info
  aiProvider      String?  // "ANTHROPIC", "OPENAI", "GEMINI"
  aiModel         String?  // Specific model used

  // Metadata
  generatedBy     String?  // "system" or user ID if manually triggered
  isLatest        Boolean  @default(true)

  createdAt       DateTime @default(now())

  @@unique([candidateId, version])
  @@index([candidateId, isLatest])
  @@index([candidateId, analysisType])
  @@index([triggerStage])
}

// ============================================
// COMMUNICATION SETTINGS
// ============================================

model EmailSettings {
  id                      String   @id @default(uuid())
  organizationId          String   @unique

  // Gmail connection
  gmailConnected          Boolean  @default(false)
  gmailDomain             String?
  gmailServiceAccountKey  String?  @db.Text  // Encrypted

  // Sender settings
  defaultFromName         String?  // Template: "{{recruiter.name}} from Curacel"
  defaultCcEmail          String?  // peopleops@curacel.ai
  defaultReplyTo          String?

  // Tracking
  trackOpens              Boolean  @default(true)
  trackClicks             Boolean  @default(true)

  // Auto-send per stage (JSON: { "APPLIED": true, "HR_SCREEN": true, ... })
  autoSendStages          Json?
  autoSendOnApplication   Boolean  @default(true)

  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
}

// Queued emails for automatic stage transition notifications
model QueuedStageEmail {
  id              String   @id @default(uuid())
  candidateId     String
  candidate       JobCandidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  // Stage transition info
  fromStage       String?
  toStage         String

  // Email details
  templateId      String?
  recruiterId     String   // User who triggered the stage change
  recruiterEmail  String
  recruiterName   String?

  // Scheduling
  scheduledFor    DateTime // When to send (now + delay)

  // Status tracking
  status          String   @default("PENDING") // PENDING, PROCESSING, SENT, FAILED, CANCELLED
  processedAt     DateTime?
  error           String?  @db.Text
  emailId         String?  // Reference to CandidateEmail once sent

  // User override
  skipAutoEmail   Boolean  @default(false) // User chose to skip auto-email for this move

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([status, scheduledFor])
  @@index([candidateId])
}

model ReminderSettings {
  id                      String   @id @default(uuid())
  organizationId          String   @unique

  // Candidate reminders
  daysBeforeFirstReminder Int      @default(3)
  daysBetweenReminders    Int      @default(3)
  maxReminders            Int      @default(3)
  reminderTemplateId      String?

  // Recruiter escalation
  daysBeforeEscalation    Int      @default(7)
  escalationMethod        String   @default("both")  // "email", "in_app", "both"
  escalateTo              String   @default("assigned")  // "assigned", "followers", "all"

  // Per-stage overrides (JSON)
  stageOverrides          Json?

  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
}

model BlueAIInterviewsSettings {
  id                      String   @id @default(uuid())
  organizationId          String   @unique

  // Auto-analysis triggers
  analyzeOnApplication    Boolean  @default(true)
  analyzeOnStageComplete  Boolean  @default(true)
  analyzeOnInterview      Boolean  @default(true)
  analyzeOnAssessment     Boolean  @default(true)

  // Analysis depth: "basic", "standard", "comprehensive"
  analysisDepth           String   @default("standard")

  // Sentiment tracking
  trackSentiment          Boolean  @default(true)
  sentimentAlertThreshold Int      @default(20)  // Points drop to trigger alert

  // Custom prompts
  customAnalysisPrompt    String?  @db.Text

  // Tab summaries
  enableTabSummaries      Boolean  @default(true)
  tabSummaryRefresh       String   @default("on_view")  // "manual", "on_view", "daily"

  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
}

// ============================================
// INTEGRATION & WEBHOOK SYSTEM
// ============================================

// Integration Settings - configuration for external platforms
model IntegrationSettings {
  id                      String   @id @default(uuid())
  platform                String   @unique  // "KANDI", "HACKERRANK", "CODILITY", "TESTGORILLA", "WEBHOOK"
  displayName             String

  // Authentication
  apiKeyEncrypted         String?  @db.Text
  apiSecretEncrypted      String?  @db.Text
  webhookSecretEncrypted  String?  @db.Text

  // Configuration
  config                  Json?    // Platform-specific config (baseUrl, organizationId, etc.)

  // Status
  isEnabled               Boolean  @default(false)
  lastTestedAt            DateTime?
  lastTestResult          String?  // "success" or error message

  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  @@index([platform])
  @@index([isEnabled])
}

// Webhook Log - track incoming webhook events
model WebhookLog {
  id                String   @id @default(uuid())
  source            String   // Platform that sent the webhook
  eventType         String   // Type of event
  payload           Json     // Full webhook payload

  // Processing
  status            String   // "SUCCESS", "FAILED", "IGNORED"
  errorMessage      String?  @db.Text
  processedAt       DateTime?

  // Related entities
  assessmentId      String?
  candidateId       String?

  createdAt         DateTime @default(now())

  @@index([source])
  @@index([status])
  @@index([createdAt])
}

// Standup Sync Settings - configuration for standup_mate integration
model StandupSyncSettings {
  id                    String   @id @default(uuid())

  // Connection
  apiUrl                String   @db.Text  // Standup Mate API URL
  apiKeyEncrypted       String?  @db.Text  // API key for authentication

  // Configuration
  isEnabled             Boolean  @default(false)
  syncOnHire            Boolean  @default(true)   // Auto-sync when employee is hired
  syncOnTermination     Boolean  @default(true)   // Auto-sync when employee exits

  // Status
  lastSyncAt            DateTime?
  lastTestAt            DateTime?
  lastTestResult        String?  @db.Text  // "success" or error message

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

// Standup Team Mapping - map departments/teams to standup teams
model StandupTeamMapping {
  id                    String   @id @default(uuid())

  // Mapping
  department            String   @unique  // Department name from Employee.department
  standupTeamName       String              // Team name in standup_mate

  // Status
  isActive              Boolean  @default(true)

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([department])
  @@index([isActive])
}
